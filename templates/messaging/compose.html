{% extends 'base.html' %}
{% load static %}

{% block title %}Compose Message - Kenyan Schools System{% endblock %}

{% block page_title %}Compose Message{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="glass-card p-6">
        <form method="post" enctype="multipart/form-data" id="composeForm">
            {% csrf_token %}
            
            {% if form.non_field_errors %}
            <div class="alert-error p-4 rounded-lg mb-6">
                {% for error in form.non_field_errors %}
                <p class="text-sm">{{ error }}</p>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Recipient Selection Tabs -->
            <div class="mb-6">
                <label class="form-label">Recipient Type <span class="text-red-400">*</span></label>
                <div class="flex flex-wrap gap-2 mb-4">
                    <button type="button" class="recipient-type-btn glass-button text-sm {% if form.recipient_type.value == 'individual' %}bg-blue-600/50{% endif %}" data-type="individual">
                        <i class="fas fa-user mr-1"></i>Individual
                    </button>
                    <button type="button" class="recipient-type-btn glass-button text-sm {% if form.recipient_type.value == 'all_students' %}bg-blue-600/50{% endif %}" data-type="all_students">
                        <i class="fas fa-user-graduate mr-1"></i>All Students
                    </button>
                    <button type="button" class="recipient-type-btn glass-button text-sm {% if form.recipient_type.value == 'all_teachers' %}bg-blue-600/50{% endif %}" data-type="all_teachers">
                        <i class="fas fa-chalkboard-teacher mr-1"></i>All Teachers
                    </button>
                    <button type="button" class="recipient-type-btn glass-button text-sm {% if form.recipient_type.value == 'all_parents' %}bg-blue-600/50{% endif %}" data-type="all_parents">
                        <i class="fas fa-user-friends mr-1"></i>All Parents
                    </button>
                    <button type="button" class="recipient-type-btn glass-button text-sm {% if form.recipient_type.value == 'class' %}bg-blue-600/50{% endif %}" data-type="class">
                        <i class="fas fa-users mr-1"></i>Specific Class
                    </button>
                    <button type="button" class="recipient-type-btn glass-button text-sm {% if form.recipient_type.value == 'broadcast' %}bg-blue-600/50{% endif %}" data-type="broadcast">
                        <i class="fas fa-list mr-1"></i>Broadcast List
                    </button>
                </div>
                <input type="hidden" name="recipient_type" id="recipientType" value="{{ form.recipient_type.value|default:'individual' }}">
            </div>

            <!-- Individual Recipients -->
            <div id="individualSection" class="mb-4 {% if form.recipient_type.value != 'individual' %}hidden{% endif %}">
                <label class="form-label">Select Recipients</label>
                <select name="recipients" class="glass-input select2" multiple style="width: 100%">
                    {% for user in form.recipients.field.queryset %}
                    <option value="{{ user.id }}" {% if user.id in form.recipients.value %}selected{% endif %}>
                        {{ user.get_full_name }} ({{ user.get_role_display }}) - {{ user.email }}
                    </option>
                    {% endfor %}
                </select>
                {% if form.recipients.errors %}
                <p class="text-sm text-red-400 mt-1">{{ form.recipients.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Class Selection -->
            <div id="classSection" class="mb-4 {% if form.recipient_type.value != 'class' %}hidden{% endif %}">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Class Level</label>
                        <select name="class_level" class="glass-input">
                            <option value="">Select Class</option>
                            {% for value, label in form.class_level.field.choices %}
                            <option value="{{ value }}" {% if form.class_level.value == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Stream</label>
                        <select name="stream" class="glass-input">
                            <option value="">Select Stream</option>
                            {% for value, label in form.stream.field.choices %}
                            <option value="{{ value }}" {% if form.stream.value == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                {% if form.class_level.errors %}
                <p class="text-sm text-red-400 mt-1">{{ form.class_level.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Broadcast List Selection -->
            <div id="broadcastSection" class="mb-4 {% if form.recipient_type.value != 'broadcast' %}hidden{% endif %}">
                <label class="form-label">Select Broadcast List</label>
                <select name="broadcast_list" class="glass-input">
                    <option value="">Choose a list...</option>
                    {% for list in form.broadcast_list.field.queryset %}
                    <option value="{{ list.id }}" {% if form.broadcast_list.value == list.id %}selected{% endif %}>
                        {{ list.name }} ({{ list.members.count }} members)
                    </option>
                    {% endfor %}
                </select>
                {% if form.broadcast_list.errors %}
                <p class="text-sm text-red-400 mt-1">{{ form.broadcast_list.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Message Subject -->
            <div class="mb-4">
                <label class="form-label">Subject (Optional)</label>
                <input type="text" name="subject" value="{{ form.subject.value|default:'' }}" class="glass-input" placeholder="Enter message subject">
                {% if form.subject.errors %}
                <p class="text-sm text-red-400 mt-1">{{ form.subject.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Message Content -->
            <div class="mb-4">
                <label class="form-label">Message <span class="text-red-400">*</span></label>
                <textarea name="content" rows="6" class="glass-input" required placeholder="Type your message here...">{{ form.content.value|default:'' }}</textarea>
                {% if form.content.errors %}
                <p class="text-sm text-red-400 mt-1">{{ form.content.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Attachment -->
            <div class="mb-6">
                <label class="form-label">Attachment (Optional)</label>
                <input type="file" name="attachment" class="glass-input">
                {% if form.attachment.errors %}
                <p class="text-sm text-red-400 mt-1">{{ form.attachment.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Template Button -->
            <div class="mb-4">
                <button type="button" onclick="openTemplateModal()" class="glass-button">
                    <i class="fas fa-file-alt mr-2"></i>Use Template
                </button>
            </div>

            <!-- Form Actions -->
            <div class="flex justify-end space-x-3">
                <a href="{% url 'messaging:inbox' %}" class="glass-button">Cancel</a>
                <button type="submit" class="glass-button bg-blue-600/50" id="sendBtn">
                    <i class="fas fa-paper-plane mr-2"></i>Send Message
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Template Selection Modal -->
<div id="templateModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="glass-modal max-w-2xl w-full p-6">
        <h3 class="text-xl font-bold text-white mb-4">Select Template</h3>
        <div class="grid grid-cols-2 gap-4 max-h-96 overflow-y-auto mb-4">
            {% for template in templates %}
            <div class="template-item glass-card p-3 cursor-pointer hover:bg-white/10 transition-colors" data-id="{{ template.id }}">
                <h4 class="font-medium text-white">{{ template.name }}</h4>
                <p class="text-xs text-white/60">{{ template.get_template_type_display }}</p>
                <p class="text-sm text-white/80 mt-1 truncate">{{ template.subject|truncatechars:30 }}</p>
            </div>
            {% empty %}
            <div class="col-span-2 text-center py-8">
                <i class="fas fa-file-alt text-4xl text-white/20 mb-3"></i>
                <p class="text-white/60">No templates available</p>
            </div>
            {% endfor %}
        </div>
        <div class="flex justify-end">
            <button type="button" onclick="closeTemplateModal()" class="glass-button">Close</button>
        </div>
    </div>
</div>

<!-- Include Select2 CSS and JS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function() {
        $('.select2').select2({
            placeholder: "Search for recipients...",
            allowClear: true,
            theme: 'classic',
            width: '100%'
        });
    });

    // Recipient type selection
    const recipientType = document.getElementById('recipientType');
    const individualSection = document.getElementById('individualSection');
    const classSection = document.getElementById('classSection');
    const broadcastSection = document.getElementById('broadcastSection');
    
    document.querySelectorAll('.recipient-type-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const type = this.dataset.type;
            recipientType.value = type;
            
            // Update button styles
            document.querySelectorAll('.recipient-type-btn').forEach(b => {
                b.classList.remove('bg-blue-600/50');
            });
            this.classList.add('bg-blue-600/50');
            
            // Show relevant section
            individualSection.classList.add('hidden');
            classSection.classList.add('hidden');
            broadcastSection.classList.add('hidden');
            
            if (type === 'individual') {
                individualSection.classList.remove('hidden');
            } else if (type === 'class') {
                classSection.classList.remove('hidden');
            } else if (type === 'broadcast') {
                broadcastSection.classList.remove('hidden');
            }
        });
    });

    // Template modal
    function openTemplateModal() {
        document.getElementById('templateModal').classList.remove('hidden');
        document.getElementById('templateModal').classList.add('flex');
    }

    function closeTemplateModal() {
        document.getElementById('templateModal').classList.add('hidden');
        document.getElementById('templateModal').classList.remove('flex');
    }

    // Template selection
    document.querySelectorAll('.template-item').forEach(item => {
        item.addEventListener('click', function() {
            const templateId = this.dataset.id;
            // Use a more reliable URL construction
            const url = "{% url 'messaging:template_preview' 0 %}".replace('0', templateId);
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    document.querySelector('input[name="subject"]').value = data.subject || '';
                    document.querySelector('textarea[name="content"]').value = data.content || '';
                    closeTemplateModal();
                })
                .catch(error => {
                    console.error('Error loading template:', error);
                    alert('Failed to load template. Please try again.');
                });
        });
    });

    // Close modal when clicking outside
    document.getElementById('templateModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeTemplateModal();
        }
    });

    // Form submission loading state
    document.getElementById('composeForm').addEventListener('submit', function() {
        const sendBtn = document.getElementById('sendBtn');
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
    });
</script>

<style>
    .select2-container--classic .select2-selection--multiple {
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        min-height: 45px;
    }
    
    .select2-container--classic .select2-selection--multiple .select2-selection__choice {
        background-color: rgba(59, 130, 246, 0.5);
        border: none;
        color: white;
        padding: 4px 8px;
    }
    
    .select2-container--classic .select2-search--inline .select2-search__field {
        color: white;
        margin-top: 8px;
    }
    
    .select2-container--classic .select2-results__option {
        background-color: #1e293b;
        color: white;
    }
    
    .select2-container--classic .select2-results__option--highlighted[aria-selected] {
        background-color: #3b82f6;
    }
</style>
{% endblock %}