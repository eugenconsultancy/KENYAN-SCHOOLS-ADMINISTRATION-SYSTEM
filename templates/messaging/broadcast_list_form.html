{% extends 'base.html' %}
{% load static %}

{% block title %}{% if broadcast_list %}Edit{% else %}Create{% endif %} Broadcast List - Kenyan Schools System{% endblock %}

{% block page_title %}{% if broadcast_list %}Edit Broadcast List{% else %}Create New Broadcast List{% endif %}{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="glass-card p-6">
        <form method="post" class="space-y-6">
            {% csrf_token %}
            
            {% if form.non_field_errors %}
            <div class="alert-error p-4 rounded-lg mb-6">
                {% for error in form.non_field_errors %}
                <p class="text-sm">{{ error }}</p>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Basic Information -->
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-white mb-4">List Information</h3>
                
                <div>
                    <label for="{{ form.name.id_for_label }}" class="form-label">
                        List Name <span class="text-red-400">*</span>
                    </label>
                    <input type="text" name="{{ form.name.name }}" id="{{ form.name.id_for_label }}" 
                           value="{{ form.name.value|default:'' }}" 
                           class="glass-input" 
                           placeholder="e.g., Class Reps, Sports Team, Science Department"
                           required>
                    {% if form.name.errors %}
                    <p class="text-sm text-red-400 mt-1">{{ form.name.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <div>
                    <label for="{{ form.description.id_for_label }}" class="form-label">
                        Description (Optional)
                    </label>
                    <textarea name="{{ form.description.name }}" id="{{ form.description.id_for_label }}" 
                              rows="3" class="glass-input" 
                              placeholder="Describe the purpose of this broadcast list">{{ form.description.value|default:'' }}</textarea>
                    {% if form.description.errors %}
                    <p class="text-sm text-red-400 mt-1">{{ form.description.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Dynamic Filters -->
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-white mb-4">Dynamic Filters</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="{{ form.filter_by_role.id_for_label }}" class="form-label">
                            Filter by Role
                        </label>
                        <select name="{{ form.filter_by_role.name }}" id="filterRole" class="glass-input">
                            <option value="">No Role Filter</option>
                            {% for value, label in form.filter_by_role.field.choices %}
                                {% if value %}
                                <option value="{{ value }}" {% if form.filter_by_role.value == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label for="{{ form.filter_by_class.id_for_label }}" class="form-label">
                            Filter by Class
                        </label>
                        <select name="{{ form.filter_by_class.name }}" id="filterClass" class="glass-input">
                            <option value="">No Class Filter</option>
                            {% for value, label in form.filter_by_class.field.choices %}
                                {% if value %}
                                <option value="{{ value }}" {% if form.filter_by_class.value == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label for="{{ form.filter_by_stream.id_for_label }}" class="form-label">
                            Filter by Stream
                        </label>
                        <select name="{{ form.filter_by_stream.name }}" id="filterStream" class="glass-input">
                            <option value="">No Stream Filter</option>
                            {% for value, label in form.filter_by_stream.field.choices %}
                                {% if value %}
                                <option value="{{ value }}" {% if form.filter_by_stream.value == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <!-- Filter Preview -->
                <div class="bg-blue-500/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center">
                        <i class="fas fa-filter text-blue-400 mr-2"></i>
                        Filter Preview
                    </h4>
                    
                    <div class="space-y-2 text-sm" id="filterPreview">
                        <p class="text-white/80">
                            <span class="text-white/60">Current filters:</span>
                            <span id="roleFilterPreview">None</span>
                        </p>
                        <p class="text-white/80">
                            <span class="text-white/60">Estimated members:</span>
                            <span id="memberEstimate">0</span>
                        </p>
                    </div>
                    
                    <button type="button" onclick="estimateMembers()" class="mt-3 text-sm text-blue-400 hover:text-blue-300">
                        <i class="fas fa-sync-alt mr-1"></i>Refresh estimate
                    </button>
                </div>
            </div>

            <!-- Manual Member Selection -->
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-white mb-4">Manual Members</h3>
                
                <p class="text-sm text-white/60">
                    You can manually add or remove members after creating the list.
                </p>
                
                {% if broadcast_list %}
                <div class="bg-white/5 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-3">Current Members ({{ broadcast_list.members.count }})</h4>
                    
                    <div class="max-h-40 overflow-y-auto space-y-2">
                        {% for member in broadcast_list.members.all|slice:":10" %}
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <img src="{{ member.get_profile_picture }}" alt="" class="h-6 w-6 rounded-full object-cover mr-2">
                                <span class="text-sm text-white">{{ member.get_full_name }}</span>
                            </div>
                            <span class="text-xs text-white/40">{{ member.get_role_display }}</span>
                        </div>
                        {% endfor %}
                        
                        {% if broadcast_list.members.count > 10 %}
                        <p class="text-xs text-white/40 text-center mt-2">
                            +{{ broadcast_list.members.count|add:"-10" }} more members
                        </p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Form Actions -->
            <div class="flex justify-end space-x-3 pt-6 border-t border-white/20">
                <a href="{% url 'messaging:broadcast_list_list' %}" class="glass-button">
                    Cancel
                </a>
                <button type="submit" class="glass-button bg-blue-600/50">
                    <i class="fas fa-save mr-2"></i>{% if broadcast_list %}Update{% else %}Create{% endif %} List
                </button>
            </div>
        </form>
    </div>
    
    <!-- Information Card -->
    <div class="glass-card mt-6 p-6">
        <h3 class="text-lg font-semibold text-white mb-4">About Broadcast Lists</h3>
        
        <div class="space-y-3">
            <div class="flex items-start">
                <i class="fas fa-check-circle text-green-400 mt-1 mr-3"></i>
                <div>
                    <h4 class="text-white font-medium">Dynamic Filters</h4>
                    <p class="text-sm text-white/60">Automatically include users based on their role, class, or stream. Members update automatically when users change.</p>
                </div>
            </div>
            
            <div class="flex items-start">
                <i class="fas fa-check-circle text-green-400 mt-1 mr-3"></i>
                <div>
                    <h4 class="text-white font-medium">Manual Members</h4>
                    <p class="text-sm text-white/60">Add or remove individual users after creating the list. Manual members are combined with filtered members.</p>
                </div>
            </div>
            
            <div class="flex items-start">
                <i class="fas fa-check-circle text-green-400 mt-1 mr-3"></i>
                <div>
                    <h4 class="text-white font-medium">Use Cases</h4>
                    <p class="text-sm text-white/60">Perfect for department communications, class representative updates, sports team announcements, and committee messages.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Filter preview update
    const roleFilter = document.getElementById('filterRole');
    const classFilter = document.getElementById('filterClass');
    const streamFilter = document.getElementById('filterStream');
    const rolePreview = document.getElementById('roleFilterPreview');
    const memberEstimate = document.getElementById('memberEstimate');
    
    function updateFilterPreview() {
        const filters = [];
        
        if (roleFilter.value) {
            filters.push(`Role: ${roleFilter.options[roleFilter.selectedIndex].text}`);
        }
        if (classFilter.value) {
            filters.push(`Class: Form ${classFilter.value}`);
        }
        if (streamFilter.value) {
            filters.push(`Stream: ${streamFilter.value}`);
        }
        
        rolePreview.textContent = filters.length ? filters.join(' â€¢ ') : 'None';
    }
    
    function estimateMembers() {
        // This would normally make an AJAX call to get an estimate
        // For now, show a loading indicator
        memberEstimate.textContent = 'Calculating...';
        
        setTimeout(() => {
            memberEstimate.textContent = Math.floor(Math.random() * 50) + 10 + '+';
        }, 500);
    }
    
    roleFilter.addEventListener('change', updateFilterPreview);
    classFilter.addEventListener('change', updateFilterPreview);
    streamFilter.addEventListener('change', updateFilterPreview);
    
    // Initial preview
    updateFilterPreview();
</script>
{% endblock %}