{% extends 'base.html' %}
{% load static %}

{% block title %}Salary Details - {{ salary.teacher.get_full_name }} - {{ salary.month }}/{{ salary.year }}{% endblock %}

{% block page_title %}Salary Details{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="glass-card p-6 mb-6">
        <div class="flex items-center justify-between">
            <div>
                <div class="flex items-center space-x-3 mb-2">
                    <h2 class="text-2xl font-bold text-white">Salary Slip</h2>
                    <span class="badge badge-success">Paid</span>
                </div>
                <p class="text-white/60">Period: {{ salary.get_month_display }} {{ salary.year }}</p>
                <p class="text-white/60">Payment Date: {{ salary.payment_date|date:"l, d M Y" }}</p>
            </div>
            <div class="flex space-x-2">
                {% if salary.payslip %}
                <a href="{{ salary.payslip.url }}" target="_blank" class="glass-button">
                    <i class="fas fa-file-pdf mr-2"></i>Download Payslip
                </a>
                {% endif %}
                <button onclick="window.print()" class="glass-button">
                    <i class="fas fa-print mr-2"></i>Print
                </button>
                <a href="{% url 'teachers:salary_list' %}" class="glass-button">
                    <i class="fas fa-arrow-left mr-2"></i>Back
                </a>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column - Teacher Info -->
        <div class="space-y-6">
            <!-- Teacher Information -->
            <div class="glass-card">
                <div class="border-b border-white/20 px-6 py-4">
                    <h3 class="text-lg font-semibold text-white">Teacher Information</h3>
                </div>
                <div class="p-6">
                    <div class="flex items-center mb-4">
                        <img src="{{ salary.teacher.user.get_profile_picture }}" alt="{{ salary.teacher.get_full_name }}" 
                             class="h-16 w-16 rounded-full object-cover border-2 border-white mr-4">
                        <div>
                            <h4 class="text-lg font-bold text-white">{{ salary.teacher.get_full_name }}</h4>
                            <p class="text-white/60">{{ salary.teacher.employee_number }}</p>
                            <p class="text-white/60">{{ salary.teacher.specialization }}</p>
                        </div>
                    </div>
                    
                    <dl class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <dt class="text-white/60">TSC Number:</dt>
                            <dd class="text-white">{{ salary.teacher.tsc_number }}</dd>
                        </div>
                        <div class="flex justify-between">
                            <dt class="text-white/60">ID Number:</dt>
                            <dd class="text-white">{{ salary.teacher.id_number }}</dd>
                        </div>
                        <div class="flex justify-between">
                            <dt class="text-white/60">Phone:</dt>
                            <dd class="text-white">{{ salary.teacher.phone_number }}</dd>
                        </div>
                        <div class="flex justify-between">
                            <dt class="text-white/60">Email:</dt>
                            <dd class="text-white">{{ salary.teacher.email }}</dd>
                        </div>
                    </dl>
                </div>
            </div>

            <!-- Payment Information -->
            <div class="glass-card">
                <div class="border-b border-white/20 px-6 py-4">
                    <h3 class="text-lg font-semibold text-white">Payment Information</h3>
                </div>
                <div class="p-6">
                    <dl class="space-y-3">
                        <div class="flex justify-between">
                            <dt class="text-white/60">Payment Method:</dt>
                            <dd class="text-white">{{ salary.get_payment_method_display }}</dd>
                        </div>
                        <div class="flex justify-between">
                            <dt class="text-white/60">Payment Date:</dt>
                            <dd class="text-white">{{ salary.payment_date|date:"d M Y" }}</dd>
                        </div>
                        <div class="flex justify-between">
                            <dt class="text-white/60">Transaction ID:</dt>
                            <dd class="text-white font-mono text-sm">{{ salary.id|stringformat:"06d" }}</dd>
                        </div>
                        {% if salary.payslip %}
                        <div class="mt-4">
                            <a href="{{ salary.payslip.url }}" target="_blank" class="glass-button w-full">
                                <i class="fas fa-file-pdf mr-2"></i>View Payslip
                            </a>
                        </div>
                        {% endif %}
                    </dl>
                </div>
            </div>

            <!-- Metadata -->
            <div class="glass-card">
                <div class="border-b border-white/20 px-6 py-4">
                    <h3 class="text-lg font-semibold text-white">Metadata</h3>
                </div>
                <div class="p-6">
                    <dl class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <dt class="text-white/60">Recorded By:</dt>
                            <dd class="text-white">{{ salary.teacher.user.get_full_name|default:"System" }}</dd>
                        </div>
                        <div class="flex justify-between">
                            <dt class="text-white/60">Recorded At:</dt>
                            <dd class="text-white">{{ salary.created_at|date:"d M Y H:i" }}</dd>
                        </div>
                        <div class="flex justify-between">
                            <dt class="text-white/60">Last Updated:</dt>
                            <dd class="text-white">{{ salary.updated_at|date:"d M Y H:i" }}</dd>
                        </div>
                    </dl>
                </div>
            </div>
        </div>

        <!-- Right Column - Salary Breakdown -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Salary Card -->
            <div class="glass-card p-6">
                <h3 class="text-xl font-bold text-white mb-6 text-center">SALARY SLIP</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Earnings -->
                    <div>
                        <h4 class="text-lg font-semibold text-green-400 mb-4 flex items-center">
                            <i class="fas fa-plus-circle mr-2"></i>
                            Earnings
                        </h4>
                        
                        <table class="w-full">
                            <tbody class="space-y-2">
                                <tr>
                                    <td class="text-white/60 py-1">Basic Salary</td>
                                    <td class="text-white text-right">KSh {{ salary.basic_salary|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td class="text-white/60 py-1">House Allowance</td>
                                    <td class="text-white text-right">KSh {{ salary.house_allowance|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td class="text-white/60 py-1">Transport Allowance</td>
                                    <td class="text-white text-right">KSh {{ salary.transport_allowance|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td class="text-white/60 py-1">Medical Allowance</td>
                                    <td class="text-white text-right">KSh {{ salary.medical_allowance|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td class="text-white/60 py-1">Other Allowances</td>
                                    <td class="text-white text-right">KSh {{ salary.other_allowances|floatformat:2 }}</td>
                                </tr>
                                <tr class="border-t border-white/20">
                                    <td class="text-white font-bold py-2">Gross Salary</td>
                                    <td class="text-blue-400 font-bold text-right">KSh {{ salary.basic_salary|add:salary.house_allowance|add:salary.transport_allowance|add:salary.medical_allowance|add:salary.other_allowances|floatformat:2 }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Deductions -->
                    <div>
                        <h4 class="text-lg font-semibold text-red-400 mb-4 flex items-center">
                            <i class="fas fa-minus-circle mr-2"></i>
                            Deductions
                        </h4>
                        
                        <table class="w-full">
                            <tbody class="space-y-2">
                                <tr>
                                    <td class="text-white/60 py-1">PAYE (Tax)</td>
                                    <td class="text-white text-right">KSh {{ salary.tax|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td class="text-white/60 py-1">NHIF</td>
                                    <td class="text-white text-right">KSh {{ salary.nhif|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td class="text-white/60 py-1">NSSF</td>
                                    <td class="text-white text-right">KSh {{ salary.nssf|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td class="text-white/60 py-1">Loan Deduction</td>
                                    <td class="text-white text-right">KSh {{ salary.loan_deduction|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td class="text-white/60 py-1">Other Deductions</td>
                                    <td class="text-white text-right">KSh {{ salary.other_deductions|floatformat:2 }}</td>
                                </tr>
                                <tr class="border-t border-white/20">
                                    <td class="text-white font-bold py-2">Total Deductions</td>
                                    <td class="text-red-400 font-bold text-right">KSh {{ salary.tax|add:salary.nhif|add:salary.nssf|add:salary.loan_deduction|add:salary.other_deductions|floatformat:2 }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Net Salary -->
                <div class="mt-8 pt-6 border-t-2 border-white/20">
                    <div class="flex items-center justify-between bg-green-500/10 p-4 rounded-lg">
                        <div>
                            <span class="text-white/60 text-sm">NET SALARY</span>
                            <p class="text-3xl font-bold text-green-400">KSh {{ salary.net_salary|floatformat:2 }}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-white/60 text-sm">Payment Method</span>
                            <p class="text-white">{{ salary.get_payment_method_display }}</p>
                        </div>
                    </div>
                </div>

                <!-- Amount in Words -->
                <div class="mt-4 p-4 bg-white/5 rounded-lg">
                    <p class="text-sm text-white/60">Amount in Words:</p>
                    <p class="text-white italic" id="amountInWords"></p>
                </div>

                <!-- Footer -->
                <div class="mt-6 grid grid-cols-2 gap-4 text-sm text-white/40">
                    <div>
                        <p>Generated on: {% now "d M Y H:i" %}</p>
                    </div>
                    <div class="text-right">
                        <p>Authorized Signature</p>
                        <p class="mt-8">____________________</p>
                    </div>
                </div>
            </div>

            <!-- Bank Details -->
            {% if salary.teacher.bank_name %}
            <div class="glass-card p-6">
                <h3 class="text-lg font-semibold text-white mb-4">Bank Details</h3>
                <dl class="grid grid-cols-2 gap-4">
                    <div>
                        <dt class="text-sm text-white/60">Bank Name</dt>
                        <dd class="text-white">{{ salary.teacher.bank_name }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm text-white/60">Branch</dt>
                        <dd class="text-white">{{ salary.teacher.bank_branch|default:"-" }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm text-white/60">Account Number</dt>
                        <dd class="text-white">{{ salary.teacher.bank_account|default:"-" }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm text-white/60">Bank Code</dt>
                        <dd class="text-white">{{ salary.teacher.bank_code|default:"-" }}</dd>
                    </div>
                </dl>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // Convert number to words (simplified version)
    function numberToWords(num) {
        const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine',
                     'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen',
                     'Seventeen', 'Eighteen', 'Nineteen'];
        const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
        
        if (num === 0) return 'Zero';
        
        function convertLessThanOneThousand(n) {
            if (n < 20) return ones[n];
            if (n < 100) {
                return tens[Math.floor(n / 10)] + (n % 10 !== 0 ? ' ' + ones[n % 10] : '');
            }
            return ones[Math.floor(n / 100)] + ' Hundred' + (n % 100 !== 0 ? ' and ' + convertLessThanOneThousand(n % 100) : '');
        }
        
        const numStr = num.toFixed(2);
        const [whole, decimal] = numStr.split('.');
        
        let words = '';
        let wholeNum = parseInt(whole);
        
        if (wholeNum >= 1000000) {
            words += convertLessThanOneThousand(Math.floor(wholeNum / 1000000)) + ' Million ';
            wholeNum %= 1000000;
        }
        if (wholeNum >= 1000) {
            words += convertLessThanOneThousand(Math.floor(wholeNum / 1000)) + ' Thousand ';
            wholeNum %= 1000;
        }
        if (wholeNum > 0) {
            words += convertLessThanOneThousand(wholeNum);
        }
        
        words = words.trim() + ' Shillings';
        
        if (parseInt(decimal) > 0) {
            words += ' and ' + convertLessThanOneThousand(parseInt(decimal)) + ' Cents';
        }
        
        return words;
    }

    // Display amount in words
    const netSalary = parseFloat('{{ salary.net_salary }}');
    document.getElementById('amountInWords').textContent = numberToWords(netSalary);
</script>

<style media="print">
    @page {
        size: A4;
        margin: 1cm;
    }
    
    body {
        background: white;
        padding: 20px;
    }
    
    .glass-sidebar,
    .glass-navbar,
    .glass-button,
    .no-print {
        display: none !important;
    }
    
    .glass-card {
        background: white;
        border: 1px solid #ddd;
        box-shadow: none;
        margin-bottom: 20px;
    }
    
    .text-white {
        color: black !important;
    }
    
    .text-white\/60 {
        color: #666 !important;
    }
    
    .bg-green-500\/10 {
        background: #f0f9f0 !important;
    }
    
    .badge {
        border: 1px solid #ddd;
        background: #f5f5f5;
        color: black !important;
    }
    
    .ml-64 {
        margin-left: 0;
    }
</style>
{% endblock %}