{% extends 'base.html' %}
{% load static %}

{% block title %}Budget Management - Kenyan Schools System{% endblock %}

{% block page_title %}Budget Management{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header with Actions -->
    <div class="glass-card p-4 mb-6">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div class="flex flex-wrap gap-2">
                <a href="{% url 'finance:budget_create' %}" class="glass-button bg-green-600/50">
                    <i class="fas fa-plus mr-2"></i>Create New Budget
                </a>
                <button onclick="exportBudgets()" class="glass-button">
                    <i class="fas fa-download mr-2"></i>Export
                </button>
                <button onclick="printReport()" class="glass-button">
                    <i class="fas fa-print mr-2"></i>Print
                </button>
            </div>
            
            <div class="flex gap-2">
                <select id="yearFilter" class="glass-input w-auto" onchange="filterByYear(this.value)">
                    <option value="">All Years</option>
                    {% for year in years %}
                    <option value="{{ year }}" {% if request.GET.year == year|stringformat:"i" %}selected{% endif %}>
                        {{ year }}
                    </option>
                    {% endfor %}
                </select>
                
                <select id="statusFilter" class="glass-input w-auto" onchange="filterByStatus(this.value)">
                    <option value="">All Status</option>
                    <option value="under" {% if request.GET.status == 'under' %}selected{% endif %}>Under Budget</option>
                    <option value="over" {% if request.GET.status == 'over' %}selected{% endif %}>Over Budget</option>
                    <option value="critical" {% if request.GET.status == 'critical' %}selected{% endif %}>Critical</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="glass-card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-white/60">Total Budget</p>
                    <p class="text-2xl font-bold text-white">KSh {{ total_budget|floatformat:2 }}</p>
                </div>
                <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-chart-pie text-blue-400 text-xl"></i>
                </div>
            </div>
            <p class="text-xs text-white/40 mt-2">{{ budgets.count }} active budgets</p>
        </div>

        <div class="glass-card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-white/60">Total Spent</p>
                    <p class="text-2xl font-bold text-yellow-400">KSh {{ total_spent|floatformat:2 }}</p>
                </div>
                <div class="w-12 h-12 bg-yellow-500/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-receipt text-yellow-400 text-xl"></i>
                </div>
            </div>
            <p class="text-xs text-white/40 mt-2">{{ utilization_rate|floatformat:1 }}% utilization</p>
        </div>

        <div class="glass-card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-white/60">Remaining</p>
                    <p class="text-2xl font-bold text-green-400">KSh {{ total_remaining|floatformat:2 }}</p>
                </div>
                <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-coins text-green-400 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="glass-card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-white/60">Over Budget</p>
                    <p class="text-2xl font-bold text-red-400">KSh {{ total_over|floatformat:2 }}</p>
                </div>
                <div class="w-12 h-12 bg-red-500/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-red-400 text-xl"></i>
                </div>
            </div>
            <p class="text-xs text-white/40 mt-2">{{ over_budget_count }} categories over budget</p>
        </div>
    </div>

    <!-- Budget List -->
    <div class="glass-card overflow-hidden mb-6">
        <div class="border-b border-white/20 px-6 py-4">
            <h3 class="text-lg font-semibold text-white">Budget Allocations</h3>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead>
                    <tr class="bg-white/5">
                        <th class="px-6 py-3 text-left text-xs font-medium text-white/80 uppercase">Academic Year</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white/80 uppercase">Category</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-white/80 uppercase">Allocated</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-white/80 uppercase">Spent</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-white/80 uppercase">Remaining</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-white/80 uppercase">Utilization</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-white/80 uppercase">Status</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-white/80 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/10">
                    {% for budget in budgets %}
                    <tr class="hover:bg-white/5 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-white font-medium">{{ budget.academic_year.name }}</span>
                        </td>
                        <td class="px-6 py-4">
                            <div>
                                <p class="text-white font-medium">{{ budget.category.name }}</p>
                                <p class="text-xs text-white/40">{{ budget.category.code }}</p>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <span class="text-white">KSh {{ budget.allocated_amount|floatformat:2 }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <span class="text-yellow-400">KSh {{ budget.spent_amount|floatformat:2 }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            {% if budget.remaining_amount >= 0 %}
                            <span class="text-green-400">KSh {{ budget.remaining_amount|floatformat:2 }}</span>
                            {% else %}
                            <span class="text-red-400">KSh {{ budget.remaining_amount|floatformat:2 }}</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center justify-center">
                                {% widthratio budget.spent_amount budget.allocated_amount 100 as utilization %}
                                <div class="w-24 bg-white/20 rounded-full h-2 mr-2">
                                    <div class="{% if utilization > 100 %}bg-red-500{% elif utilization > 80 %}bg-yellow-500{% else %}bg-green-500{% endif %} h-2 rounded-full" 
                                         style="width: {{ utilization }}%"></div>
                                </div>
                                <span class="text-white text-sm">{{ utilization }}%</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            {% if utilization > 100 %}
                            <span class="badge badge-error">Over Budget</span>
                            {% elif utilization > 80 %}
                            <span class="badge badge-warning">Warning</span>
                            {% else %}
                            <span class="badge badge-success">On Track</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <div class="flex justify-end space-x-2">
                                <a href="{% url 'finance:budget_edit' budget.id %}" 
                                   class="text-white/60 hover:text-white" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button onclick="viewDetails({{ budget.id }})" 
                                        class="text-white/60 hover:text-white" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <a href="{% url 'reports:budget_report' budget.academic_year.name %}" 
                                   class="text-white/60 hover:text-white" title="Report">
                                    <i class="fas fa-file-pdf"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="px-6 py-12 text-center">
                            <div class="flex flex-col items-center">
                                <div class="w-20 h-20 bg-white/5 rounded-full flex items-center justify-center mb-4">
                                    <i class="fas fa-chart-pie text-3xl text-white/40"></i>
                                </div>
                                <h3 class="text-xl font-semibold text-white mb-2">No Budgets Found</h3>
                                <p class="text-white/60 mb-6">Create your first budget to start tracking expenses.</p>
                                <a href="{% url 'finance:budget_create' %}" class="glass-button">
                                    <i class="fas fa-plus mr-2"></i>Create Budget
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Budget Analysis Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Allocation by Category -->
        <div class="glass-card">
            <div class="border-b border-white/20 px-6 py-4">
                <h3 class="text-lg font-semibold text-white">Budget Allocation by Category</h3>
            </div>
            <div class="p-6">
                <canvas id="allocationChart" height="200"></canvas>
            </div>
        </div>

        <!-- Monthly Spending Trend -->
        <div class="glass-card">
            <div class="border-b border-white/20 px-6 py-4">
                <h3 class="text-lg font-semibold text-white">Monthly Spending Trend</h3>
            </div>
            <div class="p-6">
                <canvas id="spendingChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Top Spending Categories -->
    <div class="glass-card">
        <div class="border-b border-white/20 px-6 py-4">
            <h3 class="text-lg font-semibold text-white">Top Spending Categories</h3>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                {% for budget in top_spending %}
                <div class="bg-white/5 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-white font-medium">{{ budget.category.name }}</h4>
                        <span class="badge {% if budget.utilization > 100 %}badge-error{% elif budget.utilization > 80 %}badge-warning{% else %}badge-success{% endif %}">
                            {{ budget.utilization|floatformat:0 }}%
                        </span>
                    </div>
                    <p class="text-2xl font-bold text-white mb-2">KSh {{ budget.spent_amount|floatformat:2 }}</p>
                    <div class="flex justify-between text-sm">
                        <span class="text-white/60">of KSh {{ budget.allocated_amount|floatformat:2 }}</span>
                        <span class="{% if budget.remaining_amount >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                            {{ budget.remaining_amount|floatformat:2 }}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div id="detailsModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="glass-modal max-w-2xl w-full p-6">
        <h3 class="text-xl font-bold text-white mb-4">Budget Details</h3>
        <div id="detailsContent" class="space-y-4 mb-6">
            <!-- Populated by JavaScript -->
        </div>
        <div class="flex justify-end">
            <button type="button" onclick="closeDetailsModal()" class="glass-button">Close</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Filter functions
    function filterByYear(year) {
        const url = new URL(window.location.href);
        if (year) {
            url.searchParams.set('year', year);
        } else {
            url.searchParams.delete('year');
        }
        url.searchParams.set('page', '1');
        window.location.href = url.toString();
    }

    function filterByStatus(status) {
        const url = new URL(window.location.href);
        if (status) {
            url.searchParams.set('status', status);
        } else {
            url.searchParams.delete('status');
        }
        url.searchParams.set('page', '1');
        window.location.href = url.toString();
    }

    // Export and Print
    function exportBudgets() {
        window.location.href = '{% url "finance:export_budgets" %}?' + new URLSearchParams({
            year: document.getElementById('yearFilter').value,
            status: document.getElementById('statusFilter').value
        }).toString();
    }

    function printReport() {
        window.print();
    }

    // Details Modal
    function viewDetails(id) {
        fetch(`/finance/api/budget/${id}/`)
            .then(response => response.json())
            .then(data => {
                const content = document.getElementById('detailsContent');
                content.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-white/60">Academic Year</p>
                            <p class="text-white font-medium">${data.academic_year}</p>
                        </div>
                        <div>
                            <p class="text-sm text-white/60">Category</p>
                            <p class="text-white font-medium">${data.category}</p>
                        </div>
                        <div>
                            <p class="text-sm text-white/60">Allocated Amount</p>
                            <p class="text-white font-medium">KSh ${data.allocated}</p>
                        </div>
                        <div>
                            <p class="text-sm text-white/60">Spent Amount</p>
                            <p class="text-yellow-400 font-medium">KSh ${data.spent}</p>
                        </div>
                        <div>
                            <p class="text-sm text-white/60">Remaining</p>
                            <p class="${data.remaining >= 0 ? 'text-green-400' : 'text-red-400'} font-medium">
                                KSh ${data.remaining}
                            </p>
                        </div>
                        <div>
                            <p class="text-sm text-white/60">Utilization</p>
                            <p class="text-white font-medium">${data.utilization}%</p>
                        </div>
                    </div>
                    ${data.notes ? `
                    <div>
                        <p class="text-sm text-white/60">Notes</p>
                        <p class="text-white bg-white/5 rounded p-2">${data.notes}</p>
                    </div>
                    ` : ''}
                `;
                document.getElementById('detailsModal').classList.remove('hidden');
                document.getElementById('detailsModal').classList.add('flex');
            });
    }

    function closeDetailsModal() {
        document.getElementById('detailsModal').classList.add('hidden');
        document.getElementById('detailsModal').classList.remove('flex');
    }

    // Charts
    const allocationCtx = document.getElementById('allocationChart').getContext('2d');
    new Chart(allocationCtx, {
        type: 'doughnut',
        data: {
            labels: {{ chart_labels|safe }},
            datasets: [{
                data: {{ chart_data|safe }},
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(139, 92, 246, 0.8)',
                    'rgba(236, 72, 153, 0.8)'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: 'white'
                    }
                }
            }
        }
    });

    const spendingCtx = document.getElementById('spendingChart').getContext('2d');
    new Chart(spendingCtx, {
        type: 'line',
        data: {
            labels: {{ months|safe }},
            datasets: [{
                label: 'Monthly Spending',
                data: {{ monthly_spending|safe }},
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: 'white'
                    }
                }
            },
            scales: {
                y: {
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)',
                        callback: function(value) {
                            return 'KSh ' + value.toLocaleString();
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });

    // Close modal when clicking outside
    document.getElementById('detailsModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDetailsModal();
        }
    });
</script>

<style>
    @media print {
        .glass-sidebar,
        .glass-navbar,
        .glass-button,
        .no-print {
            display: none !important;
        }
        
        body {
            background: white;
        }
        
        .glass-card {
            background: white;
            border: 1px solid #ddd;
            box-shadow: none;
        }
        
        .text-white {
            color: black !important;
        }
        
        .badge {
            border: 1px solid #ddd;
            background: #f5f5f5;
            color: black !important;
        }
    }
</style>
{% endblock %}