{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - Kenyan Schools System{% endblock %}

{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Debug Information - Remove in production -->
    {% if student %}
    <div class="bg-yellow-500/20 border border-yellow-500/30 rounded-lg p-4 mb-4">
        <div class="flex items-center">
            <i class="fas fa-info-circle text-yellow-400 mr-3 text-xl"></i>
            <div>
                <p class="text-yellow-400 font-medium">DEBUG: Editing Mode</p>
                <p class="text-yellow-400/80 text-sm">Student ID: {{ student.id }} - {{ student.get_full_name }}</p>
                <p class="text-yellow-400/60 text-xs">Form will submit to: {% url 'students:edit' student.id %}</p>
            </div>
        </div>
    </div>
    {% else %}
    <div class="bg-green-500/20 border border-green-500/30 rounded-lg p-4 mb-4">
        <div class="flex items-center">
            <i class="fas fa-info-circle text-green-400 mr-3 text-xl"></i>
            <div>
                <p class="text-green-400 font-medium">DEBUG: Create Mode</p>
                <p class="text-green-400/80 text-sm">Creating new student</p>
                <p class="text-green-400/60 text-xs">Form will submit to: {% url 'students:create' %}</p>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="glass-card p-6">
        <form method="post" enctype="multipart/form-data" 
              action="{% if student %}{% url 'students:edit' student.id %}{% else %}{% url 'students:create' %}{% endif %}" 
              class="space-y-6">
            {% csrf_token %}
            
            {% if form.non_field_errors %}
            <div class="alert-error p-4 rounded-lg">
                {% for error in form.non_field_errors %}
                <p class="text-sm">{{ error }}</p>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Hidden field to indicate this is a create form -->
            {% if not student %}
            <input type="hidden" name="action" value="create">
            {% endif %}
            
            <!-- User Account Information -->
            <div>
                <h3 class="text-lg font-semibold text-white mb-4">Account Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="{{ form.username.id_for_label }}" class="form-label">
                            Username <span class="text-red-400">*</span>
                        </label>
                        <input type="text" name="{{ form.username.name }}" id="{{ form.username.id_for_label }}" 
                               value="{{ form.username.value|default:'' }}" class="glass-input" required>
                        {% if form.username.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.username.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.email.id_for_label }}" class="form-label">
                            Email <span class="text-red-400">*</span>
                        </label>
                        <input type="email" name="{{ form.email.name }}" id="{{ form.email.id_for_label }}" 
                               value="{{ form.email.value|default:'' }}" class="glass-input" required>
                        {% if form.email.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.email.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.first_name.id_for_label }}" class="form-label">
                            First Name <span class="text-red-400">*</span>
                        </label>
                        <input type="text" name="{{ form.first_name.name }}" id="{{ form.first_name.id_for_label }}" 
                               value="{{ form.first_name.value|default:'' }}" class="glass-input" required>
                        {% if form.first_name.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.first_name.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.last_name.id_for_label }}" class="form-label">
                            Last Name <span class="text-red-400">*</span>
                        </label>
                        <input type="text" name="{{ form.last_name.name }}" id="{{ form.last_name.id_for_label }}" 
                               value="{{ form.last_name.value|default:'' }}" class="glass-input" required>
                        {% if form.last_name.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.last_name.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.password.id_for_label }}" class="form-label">
                            Password
                        </label>
                        <input type="password" name="{{ form.password.name }}" id="{{ form.password.id_for_label }}" 
                               class="glass-input" {% if not student %}required{% endif %}>
                        {% if form.password.help_text %}
                        <p class="text-xs text-white/60 mt-1">{{ form.password.help_text }}</p>
                        {% endif %}
                        {% if form.password.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.password.errors.0 }}</p>
                        {% endif %}
                        {% if student %}
                        <p class="text-xs text-white/40 mt-1">Leave blank to keep current password</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="border-t border-white/20 my-6"></div>
            
            <!-- Personal Information -->
            <div>
                <h3 class="text-lg font-semibold text-white mb-4">Personal Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="{{ form.admission_number.id_for_label }}" class="form-label">
                            Admission Number <span class="text-red-400">*</span>
                        </label>
                        <input type="text" name="{{ form.admission_number.name }}" id="{{ form.admission_number.id_for_label }}" 
                               value="{{ form.admission_number.value|default:'' }}" class="glass-input" required>
                        {% if form.admission_number.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.admission_number.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.kcpe_index.id_for_label }}" class="form-label">
                            KCPE Index <span class="text-red-400">*</span>
                        </label>
                        <input type="text" name="{{ form.kcpe_index.name }}" id="{{ form.kcpe_index.id_for_label }}" 
                               value="{{ form.kcpe_index.value|default:'' }}" class="glass-input" required>
                        {% if form.kcpe_index.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.kcpe_index.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.kcpe_marks.id_for_label }}" class="form-label">
                            KCPE Marks <span class="text-red-400">*</span>
                        </label>
                        <input type="number" name="{{ form.kcpe_marks.name }}" id="{{ form.kcpe_marks.id_for_label }}" 
                               value="{{ form.kcpe_marks.value|default:'' }}" class="glass-input" min="0" max="500" required>
                        {% if form.kcpe_marks.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.kcpe_marks.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.date_of_birth.id_for_label }}" class="form-label">
                            Date of Birth <span class="text-red-400">*</span>
                        </label>
                        <input type="date" name="{{ form.date_of_birth.name }}" id="{{ form.date_of_birth.id_for_label }}" 
                               value="{{ form.date_of_birth.value|default:'' }}" class="glass-input" required>
                        {% if form.date_of_birth.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.date_of_birth.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.gender.id_for_label }}" class="form-label">
                            Gender <span class="text-red-400">*</span>
                        </label>
                        <select name="{{ form.gender.name }}" id="{{ form.gender.id_for_label }}" class="glass-input" required>
                            <option value="">Select Gender</option>
                            {% for value, label in form.gender.field.choices %}
                                {% if value %}
                                <option value="{{ value }}" {% if form.gender.value == value %}selected{% endif %}>{{ label }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        {% if form.gender.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.gender.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.boarding_status.id_for_label }}" class="form-label">
                            Boarding Status
                        </label>
                        <select name="{{ form.boarding_status.name }}" id="{{ form.boarding_status.id_for_label }}" class="glass-input">
                            <option value="">Select Status</option>
                            {% for value, label in form.boarding_status.field.choices %}
                                {% if value %}
                                <option value="{{ value }}" {% if form.boarding_status.value == value %}selected{% endif %}>{{ label }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        {% if form.boarding_status.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.boarding_status.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Academic Information -->
            <div>
                <h3 class="text-lg font-semibold text-white mb-4">Academic Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="{{ form.current_class.id_for_label }}" class="form-label">
                            Current Class <span class="text-red-400">*</span>
                        </label>
                        <select name="{{ form.current_class.name }}" id="{{ form.current_class.id_for_label }}" class="glass-input" required>
                            <option value="">Select Class</option>
                            {% for value, label in form.current_class.field.choices %}
                                {% if value %}
                                <option value="{{ value }}" {% if form.current_class.value == value %}selected{% endif %}>{{ label }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        {% if form.current_class.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.current_class.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.stream.id_for_label }}" class="form-label">
                            Stream <span class="text-red-400">*</span>
                        </label>
                        <select name="{{ form.stream.name }}" id="{{ form.stream.id_for_label }}" class="glass-input" required>
                            <option value="">Select Stream</option>
                            {% for value, label in form.stream.field.choices %}
                                {% if value %}
                                <option value="{{ value }}" {% if form.stream.value == value %}selected{% endif %}>{{ label }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        {% if form.stream.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.stream.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.admission_class.id_for_label }}" class="form-label">
                            Admission Class <span class="text-red-400">*</span>
                        </label>
                        <select name="{{ form.admission_class.name }}" id="{{ form.admission_class.id_for_label }}" class="glass-input" required>
                            <option value="">Select Class</option>
                            {% for value, label in form.admission_class.field.choices %}
                                {% if value %}
                                <option value="{{ value }}" {% if form.admission_class.value == value %}selected{% endif %}>{{ label }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        {% if form.admission_class.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.admission_class.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.year_of_admission.id_for_label }}" class="form-label">
                            Year of Admission
                        </label>
                        <input type="number" name="{{ form.year_of_admission.name }}" id="{{ form.year_of_admission.id_for_label }}" 
                               value="{{ form.year_of_admission.value|default:'' }}" class="glass-input" min="2000" max="2100">
                        {% if form.year_of_admission.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.year_of_admission.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div class="md:col-span-2">
                        <label for="{{ form.previous_school.id_for_label }}" class="form-label">
                            Previous School
                        </label>
                        <input type="text" name="{{ form.previous_school.name }}" id="{{ form.previous_school.id_for_label }}" 
                               value="{{ form.previous_school.value|default:'' }}" class="glass-input">
                        {% if form.previous_school.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.previous_school.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Contact Information -->
            <div>
                <h3 class="text-lg font-semibold text-white mb-4">Contact Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="{{ form.phone_number.id_for_label }}" class="form-label">
                            Phone Number
                        </label>
                        <input type="text" name="{{ form.phone_number.name }}" id="{{ form.phone_number.id_for_label }}" 
                               value="{{ form.phone_number.value|default:'' }}" class="glass-input">
                        {% if form.phone_number.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.phone_number.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.alternative_phone.id_for_label }}" class="form-label">
                            Alternative Phone
                        </label>
                        <input type="text" name="{{ form.alternative_phone.name }}" id="{{ form.alternative_phone.id_for_label }}" 
                               value="{{ form.alternative_phone.value|default:'' }}" class="glass-input">
                        {% if form.alternative_phone.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.alternative_phone.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div class="md:col-span-2">
                        <label for="{{ form.physical_address.id_for_label }}" class="form-label">
                            Physical Address
                        </label>
                        <textarea name="{{ form.physical_address.name }}" id="{{ form.physical_address.id_for_label }}" 
                                  rows="2" class="glass-input">{{ form.physical_address.value|default:'' }}</textarea>
                        {% if form.physical_address.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.physical_address.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.postal_address.id_for_label }}" class="form-label">
                            Postal Address
                        </label>
                        <input type="text" name="{{ form.postal_address.name }}" id="{{ form.postal_address.id_for_label }}" 
                               value="{{ form.postal_address.value|default:'' }}" class="glass-input">
                        {% if form.postal_address.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.postal_address.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Parent/Guardian Information -->
            <div>
                <h3 class="text-lg font-semibold text-white mb-4">Parent/Guardian Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="{{ form.parent_name.id_for_label }}" class="form-label">
                            Parent Name <span class="text-red-400">*</span>
                        </label>
                        <input type="text" name="{{ form.parent_name.name }}" id="{{ form.parent_name.id_for_label }}" 
                               value="{{ form.parent_name.value|default:'' }}" class="glass-input" required>
                        {% if form.parent_name.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.parent_name.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.parent_phone.id_for_label }}" class="form-label">
                            Parent Phone <span class="text-red-400">*</span>
                        </label>
                        <input type="text" name="{{ form.parent_phone.name }}" id="{{ form.parent_phone.id_for_label }}" 
                               value="{{ form.parent_phone.value|default:'' }}" class="glass-input" required>
                        {% if form.parent_phone.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.parent_phone.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.parent_email.id_for_label }}" class="form-label">
                            Parent Email
                        </label>
                        <input type="email" name="{{ form.parent_email.name }}" id="{{ form.parent_email.id_for_label }}" 
                               value="{{ form.parent_email.value|default:'' }}" class="glass-input">
                        {% if form.parent_email.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.parent_email.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.parent_occupation.id_for_label }}" class="form-label">
                            Parent Occupation
                        </label>
                        <input type="text" name="{{ form.parent_occupation.name }}" id="{{ form.parent_occupation.id_for_label }}" 
                               value="{{ form.parent_occupation.value|default:'' }}" class="glass-input">
                        {% if form.parent_occupation.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.parent_occupation.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Emergency Contact -->
            <div>
                <h3 class="text-lg font-semibold text-white mb-4">Emergency Contact</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="{{ form.emergency_contact_name.id_for_label }}" class="form-label">
                            Contact Name <span class="text-red-400">*</span>
                        </label>
                        <input type="text" name="{{ form.emergency_contact_name.name }}" id="{{ form.emergency_contact_name.id_for_label }}" 
                               value="{{ form.emergency_contact_name.value|default:'' }}" class="glass-input" required>
                        {% if form.emergency_contact_name.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.emergency_contact_name.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.emergency_contact_phone.id_for_label }}" class="form-label">
                            Contact Phone <span class="text-red-400">*</span>
                        </label>
                        <input type="text" name="{{ form.emergency_contact_phone.name }}" id="{{ form.emergency_contact_phone.id_for_label }}" 
                               value="{{ form.emergency_contact_phone.value|default:'' }}" class="glass-input" required>
                        {% if form.emergency_contact_phone.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.emergency_contact_phone.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.emergency_contact_relationship.id_for_label }}" class="form-label">
                            Relationship <span class="text-red-400">*</span>
                        </label>
                        <input type="text" name="{{ form.emergency_contact_relationship.name }}" id="{{ form.emergency_contact_relationship.id_for_label }}" 
                               value="{{ form.emergency_contact_relationship.value|default:'' }}" class="glass-input" required>
                        {% if form.emergency_contact_relationship.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.emergency_contact_relationship.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Additional Information -->
            <div>
                <h3 class="text-lg font-semibold text-white mb-4">Additional Information</h3>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label for="{{ form.medical_conditions.id_for_label }}" class="form-label">
                            Medical Conditions / Allergies
                        </label>
                        <textarea name="{{ form.medical_conditions.name }}" id="{{ form.medical_conditions.id_for_label }}" 
                                  rows="3" class="glass-input">{{ form.medical_conditions.value|default:'' }}</textarea>
                        {% if form.medical_conditions.help_text %}
                        <p class="text-xs text-white/60 mt-1">{{ form.medical_conditions.help_text }}</p>
                        {% endif %}
                        {% if form.medical_conditions.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.medical_conditions.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.notes.id_for_label }}" class="form-label">
                            Additional Notes
                        </label>
                        <textarea name="{{ form.notes.name }}" id="{{ form.notes.id_for_label }}" 
                                  rows="3" class="glass-input">{{ form.notes.value|default:'' }}</textarea>
                        {% if form.notes.errors %}
                        <p class="text-sm text-red-400 mt-1">{{ form.notes.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div class="flex items-center">
                        <label for="{{ form.is_active.id_for_label }}" class="flex items-center cursor-pointer">
                            <input type="checkbox" name="{{ form.is_active.name }}" id="{{ form.is_active.id_for_label }}" 
                                   {% if form.is_active.value %}checked{% endif %} class="form-checkbox h-5 w-5 text-blue-600">
                            <span class="ml-2 text-white">Active Student</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Form Actions -->
            <div class="flex justify-end space-x-3 pt-6 border-t border-white/20">
                <a href="{% if student %}{% url 'students:detail' student.id %}{% else %}{% url 'students:list' %}{% endif %}" 
                   class="glass-button">
                    Cancel
                </a>
                <button type="submit" class="glass-button bg-blue-600/50">
                    <i class="fas fa-save mr-2"></i>{% if student %}Update{% else %}Create{% endif %} Student
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}