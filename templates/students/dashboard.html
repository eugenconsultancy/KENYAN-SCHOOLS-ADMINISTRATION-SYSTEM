{% extends 'base.html' %}
{% load static %}

{% block title %}Student Dashboard - Kenyan Schools System{% endblock %}

{% block page_title %}My Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Welcome Section -->
    <div class="glass-card p-6 mb-8">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <img src="{{ student.user.get_profile_picture }}" alt="{{ student.get_full_name }}" 
                     class="h-20 w-20 rounded-full object-cover border-4 border-white">
            </div>
            <div class="ml-6">
                <h2 class="text-2xl font-bold text-white">Welcome back, {{ student.get_full_name }}!</h2>
                <p class="text-white/80">Admission: {{ student.admission_number }} | Form {{ student.current_class }} {{ student.stream }}</p>
                <p class="text-white/60 text-sm mt-1">{{ current_term }}</p>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="glass-card stat-card">
            <div class="stat-icon">
                <i class="fas fa-chart-line text-2xl text-blue-400"></i>
            </div>
            <div class="stat-value">{{ average|floatformat:1 }}</div>
            <div class="stat-label">Term Average</div>
            <div class="stat-change">{{ results.count }} Subjects</div>
        </div>
        
        <div class="glass-card stat-card">
            <div class="stat-icon">
                <i class="fas fa-calendar-check text-2xl text-green-400"></i>
            </div>
            <div class="stat-value">{{ attendance_percentage|floatformat:1 }}%</div>
            <div class="stat-label">Attendance Rate</div>
            <div class="stat-change">{{ present_days }}/{{ total_days }} Days</div>
        </div>
        
        <div class="glass-card stat-card">
            <div class="stat-icon">
                <i class="fas fa-wallet text-2xl text-yellow-400"></i>
            </div>
            <div class="stat-value">KSh {{ total_paid|floatformat:0 }}</div>
            <div class="stat-label">Fees Paid</div>
            <div class="stat-change">This Term</div>
        </div>
        
        <div class="glass-card stat-card">
            <div class="stat-icon">
                <i class="fas fa-trophy text-2xl text-purple-400"></i>
            </div>
            <div class="stat-value">{{ clubs.count|add:sports.count }}</div>
            <div class="stat-label">Activities</div>
            <div class="stat-change">{{ clubs.count }} Clubs, {{ sports.count }} Sports</div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column - Recent Results -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Current Term Results -->
            <div class="glass-card">
                <div class="border-b border-white/20 px-6 py-4 flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-white">Current Term Results</h3>
                    <a href="{% url 'academics:student_results' student.id %}" class="text-white/60 hover:text-white text-sm">
                        View All <i class="fas fa-arrow-right ml-1"></i>
                    </a>
                </div>
                <div class="p-6">
                    {% if results %}
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="text-white/60 text-sm">
                                    <th class="px-4 py-2 text-left">Subject</th>
                                    <th class="px-4 py-2 text-center">Marks</th>
                                    <th class="px-4 py-2 text-center">Grade</th>
                                    <th class="px-4 py-2 text-center">Points</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in results %}
                                <tr class="border-t border-white/10">
                                    <td class="px-4 py-3 text-white">{{ result.subject.name }}</td>
                                    <td class="px-4 py-3 text-center text-white font-medium">{{ result.marks }}</td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="badge 
                                            {% if result.grade == 'A' or result.grade == 'A-' %}badge-success
                                            {% elif result.grade == 'B+' or result.grade == 'B' or result.grade == 'B-' %}badge-info
                                            {% elif result.grade == 'C+' or result.grade == 'C' or result.grade == 'C-' %}badge-warning
                                            {% else %}badge-error{% endif %}">
                                            {{ result.grade }}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 text-center text-white">{{ result.points }}</td>
                                </tr>
                                {% endfor %}
                                <tr class="border-t-2 border-white/20 font-medium">
                                    <td class="px-4 py-3 text-white">Total/Average</td>
                                    <td class="px-4 py-3 text-center text-white">{{ results|length }} subjects</td>
                                    <td class="px-4 py-3 text-center text-white">{{ average|floatformat:1 }}%</td>
                                    <td class="px-4 py-3 text-center text-white">{{ total_points }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-center text-white/60">No results available for current term</p>
                    {% endif %}
                </div>
            </div>

            <!-- Upcoming Exams -->
            <div class="glass-card">
                <div class="border-b border-white/20 px-6 py-4">
                    <h3 class="text-lg font-semibold text-white">Upcoming Exams</h3>
                </div>
                <div class="p-6">
                    {% if upcoming_exams %}
                    <div class="space-y-4">
                        {% for exam in upcoming_exams %}
                        <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                            <div>
                                <p class="font-medium text-white">{{ exam.name }}</p>
                                <p class="text-sm text-white/60">{{ exam.get_exam_type_display }}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-white">{{ exam.start_date|date:"d M Y" }}</p>
                                <p class="text-xs text-white/40">{{ exam.start_date|timeuntil }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-center text-white/60">No upcoming exams</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="space-y-6">
            <!-- Attendance Summary -->
            <div class="glass-card">
                <div class="border-b border-white/20 px-6 py-4">
                    <h3 class="text-lg font-semibold text-white">Attendance Summary</h3>
                </div>
                <div class="p-6">
                    <div class="text-center mb-4">
                        <div class="inline-flex items-center justify-center w-24 h-24 rounded-full bg-white/10 mb-2">
                            <span class="text-3xl font-bold text-white">{{ attendance_percentage|floatformat:0 }}%</span>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-white/60">Present Days:</span>
                            <span class="text-white font-medium">{{ present_days }}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-white/60">Total Days:</span>
                            <span class="text-white font-medium">{{ total_days }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fee Summary -->
            <div class="glass-card">
                <div class="border-b border-white/20 px-6 py-4">
                    <h3 class="text-lg font-semibold text-white">Fee Summary</h3>
                </div>
                <div class="p-6">
                    {% for invoice in invoices %}
                    <div class="mb-3 pb-3 border-b border-white/10 last:border-0 last:mb-0 last:pb-0">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-white/60">Invoice #{{ invoice.invoice_number }}</span>
                            <span class="text-white font-medium">KSh {{ invoice.total_amount|floatformat:0 }}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-white/60">Status:</span>
                            <span class="badge 
                                {% if invoice.status == 'paid' %}badge-success
                                {% elif invoice.status == 'overdue' %}badge-error
                                {% elif invoice.status == 'partially_paid' %}badge-warning
                                {% else %}badge-info{% endif %}">
                                {{ invoice.get_status_display }}
                            </span>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-center text-white/60">No fee records</p>
                    {% endfor %}
                    
                    <div class="mt-4 pt-4 border-t border-white/20">
                        <div class="flex justify-between font-medium">
                            <span class="text-white">Total Paid:</span>
                            <span class="text-green-400">KSh {{ total_paid|floatformat:0 }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Clubs & Sports -->
            <div class="glass-card">
                <div class="border-b border-white/20 px-6 py-4">
                    <h3 class="text-lg font-semibold text-white">My Activities</h3>
                </div>
                <div class="p-6">
                    {% if clubs %}
                    <div class="mb-4">
                        <h4 class="text-sm font-medium text-white/80 mb-2">Clubs</h4>
                        <div class="space-y-2">
                            {% for club in clubs %}
                            <div class="flex justify-between items-center">
                                <span class="text-white">{{ club.name }}</span>
                                <span class="badge badge-info">{{ club.position }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if sports %}
                    <div>
                        <h4 class="text-sm font-medium text-white/80 mb-2">Sports</h4>
                        <div class="space-y-2">
                            {% for sport in sports %}
                            <div class="flex justify-between items-center">
                                <span class="text-white">{{ sport.name }}</span>
                                <span class="badge badge-success">{{ sport.position }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if not clubs and not sports %}
                    <p class="text-center text-white/60">Not participating in any activities</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}