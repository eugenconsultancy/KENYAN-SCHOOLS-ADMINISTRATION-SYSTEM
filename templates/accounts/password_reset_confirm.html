{% extends 'base.html' %}
{% load static %}

{% block title %}Set New Password - Kenyan Schools System{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="flex justify-center mb-4">
                <div class="w-20 h-20 bg-green-500/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-lock-open text-green-400 text-3xl"></i>
                </div>
            </div>
            <h2 class="text-3xl font-extrabold text-white">Set New Password</h2>
            <p class="mt-2 text-sm text-white/80">
                Please enter your new password twice.
            </p>
        </div>
        
        <div class="glass-card p-8">
            {% if validlink %}
                <!-- Valid Link Form -->
                <form method="post" class="space-y-6">
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                    <div class="alert-error p-4 rounded-lg">
                        {% for error in form.non_field_errors %}
                        <p class="text-sm">{{ error }}</p>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <!-- New Password -->
                    <div>
                        <label for="id_new_password1" class="form-label">
                            New Password <span class="text-red-400">*</span>
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-lock text-white/40"></i>
                            </div>
                            <input type="password" name="new_password1" id="id_new_password1" 
                                   class="glass-input pl-10" 
                                   placeholder="Enter new password"
                                   required>
                            <button type="button" onclick="togglePassword('id_new_password1')" 
                                    class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                <i class="fas fa-eye text-white/40 hover:text-white/60"></i>
                            </button>
                        </div>
                        {% if form.new_password1.errors %}
                        <ul class="errorlist mt-2">
                            {% for error in form.new_password1.errors %}
                            <li class="text-sm text-red-400">{{ error }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                    
                    <!-- Confirm Password -->
                    <div>
                        <label for="id_new_password2" class="form-label">
                            Confirm New Password <span class="text-red-400">*</span>
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-lock text-white/40"></i>
                            </div>
                            <input type="password" name="new_password2" id="id_new_password2" 
                                   class="glass-input pl-10" 
                                   placeholder="Confirm new password"
                                   required>
                            <button type="button" onclick="togglePassword('id_new_password2')" 
                                    class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                <i class="fas fa-eye text-white/40 hover:text-white/60"></i>
                            </button>
                        </div>
                        {% if form.new_password2.errors %}
                        <ul class="errorlist mt-2">
                            {% for error in form.new_password2.errors %}
                            <li class="text-sm text-red-400">{{ error }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                    
                    <!-- Password Requirements -->
                    <div class="bg-white/5 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-white mb-2">Password Requirements:</h4>
                        <ul class="text-xs text-white/60 space-y-1 list-disc list-inside">
                            <li>Your password must contain at least 8 characters</li>
                            <li>Your password can't be too similar to your other personal information</li>
                            <li>Your password can't be a commonly used password</li>
                            <li>Your password can't be entirely numeric</li>
                        </ul>
                    </div>
                    
                    <!-- Password Strength Meter -->
                    <div class="space-y-2">
                        <div class="flex justify-between text-xs text-white/60">
                            <span>Password Strength</span>
                            <span id="password-strength-text">Weak</span>
                        </div>
                        <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                            <div id="password-strength-bar" class="h-full w-0 bg-red-500 transition-all duration-300"></div>
                        </div>
                    </div>
                    
                    <button type="submit" class="glass-button w-full py-3" id="submit-btn" disabled>
                        <i class="fas fa-save mr-2"></i>
                        Change Password
                    </button>
                </form>
            {% else %}
                <!-- Invalid Link Message -->
                <div class="text-center">
                    <div class="flex justify-center mb-6">
                        <div class="w-24 h-24 bg-red-500/20 rounded-full flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-red-400 text-4xl"></i>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-bold text-white mb-3">Invalid Reset Link</h3>
                    
                    <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4 mb-6">
                        <p class="text-sm text-red-400">
                            The password reset link was invalid, possibly because it has already been used.
                            Please request a new password reset.
                        </p>
                    </div>
                    
                    <div class="space-y-3">
                        <a href="{% url 'accounts:password_reset' %}" class="glass-button w-full">
                            <i class="fas fa-redo-alt mr-2"></i>
                            Request New Reset Link
                        </a>
                        
                        <a href="{% url 'accounts:login' %}" class="inline-block text-sm text-white/60 hover:text-white">
                            <i class="fas fa-arrow-left mr-1"></i>
                            Back to Login
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // Toggle password visibility
    function togglePassword(fieldId) {
        const field = document.getElementById(fieldId);
        const type = field.getAttribute('type') === 'password' ? 'text' : 'password';
        field.setAttribute('type', type);
        
        // Toggle eye icon
        const button = field.nextElementSibling;
        const icon = button.querySelector('i');
        icon.classList.toggle('fa-eye');
        icon.classList.toggle('fa-eye-slash');
    }
    
    // Password strength meter
    const passwordInput = document.getElementById('id_new_password1');
    const strengthBar = document.getElementById('password-strength-bar');
    const strengthText = document.getElementById('password-strength-text');
    const submitBtn = document.getElementById('submit-btn');
    
    function checkPasswordStrength(password) {
        let strength = 0;
        
        if (password.length >= 8) strength += 25;
        if (password.match(/[a-z]+/)) strength += 25;
        if (password.match(/[A-Z]+/)) strength += 25;
        if (password.match(/[0-9]+/)) strength += 15;
        if (password.match(/[$@#&!]+/)) strength += 10;
        
        return strength;
    }
    
    passwordInput.addEventListener('input', function() {
        const strength = checkPasswordStrength(this.value);
        strengthBar.style.width = strength + '%';
        
        if (strength < 30) {
            strengthBar.className = 'h-full bg-red-500 transition-all duration-300';
            strengthText.textContent = 'Weak';
            strengthText.className = 'text-red-400';
            submitBtn.disabled = true;
        } else if (strength < 60) {
            strengthBar.className = 'h-full bg-yellow-500 transition-all duration-300';
            strengthText.textContent = 'Medium';
            strengthText.className = 'text-yellow-400';
            submitBtn.disabled = true;
        } else if (strength < 80) {
            strengthBar.className = 'h-full bg-blue-500 transition-all duration-300';
            strengthText.textContent = 'Strong';
            strengthText.className = 'text-blue-400';
            submitBtn.disabled = false;
        } else {
            strengthBar.className = 'h-full bg-green-500 transition-all duration-300';
            strengthText.textContent = 'Very Strong';
            strengthText.className = 'text-green-400';
            submitBtn.disabled = false;
        }
    });
    
    // Password match validation
    const confirmInput = document.getElementById('id_new_password2');
    
    function checkPasswordsMatch() {
        if (passwordInput.value && confirmInput.value) {
            if (passwordInput.value !== confirmInput.value) {
                confirmInput.setCustomValidity('Passwords do not match');
                confirmInput.classList.add('border-red-500');
            } else {
                confirmInput.setCustomValidity('');
                confirmInput.classList.remove('border-red-500');
            }
        }
    }
    
    passwordInput.addEventListener('change', checkPasswordsMatch);
    confirmInput.addEventListener('keyup', checkPasswordsMatch);
</script>

<style>
    body {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    }
    
    .border-red-500 {
        border-color: #ef4444 !important;
    }
</style>
{% endblock %}