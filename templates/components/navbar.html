<nav class="glass-navbar sticky top-0 z-40">
    <div class="container mx-auto px-4">
        <div class="flex items-center justify-between h-16">
            <!-- Mobile menu button (hidden on desktop) -->
            <button class="lg:hidden text-white/80 hover:text-white" onclick="toggleMobileMenu()">
                <i class="fas fa-bars text-xl"></i>
            </button>
            
            <!-- Page Title -->
            <div class="flex-1 lg:flex-initial">
                <h1 class="text-xl font-semibold text-white">{% block page_title %}Dashboard{% endblock %}</h1>
            </div>
            
            <!-- Right side items -->
            <div class="flex items-center space-x-4">
                <!-- Notifications -->
                <div class="relative" x-data="{ open: false }">
                    <button @click="open = !open; if(open) { $refs.quickActions.open = false; $refs.profileDropdown.open = false; }" 
                            class="relative text-white/80 hover:text-white">
                        <i class="fas fa-bell text-xl"></i>
                        {% if unread_notifications_count %}
                        <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
                            {{ unread_notifications_count }}
                        </span>
                        {% endif %}
                    </button>
                    
                    <!-- Notifications dropdown -->
                    <div x-show="open" 
                         @click.away="open = false" 
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="transform opacity-0 scale-95"
                         x-transition:enter-end="transform opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="transform opacity-100 scale-100"
                         x-transition:leave-end="transform opacity-0 scale-95"
                         class="absolute right-0 mt-2 w-80 glass-dropdown rounded-lg shadow-lg overflow-hidden z-50">
                        <div class="p-3 border-b border-white/20">
                            <h3 class="text-sm font-semibold text-white">Notifications</h3>
                        </div>
                        <div class="max-h-96 overflow-y-auto">
                            {% for notification in user.notifications.all|slice:":5" %}
                            <a href="{% url 'accounts:notification_detail' notification.id %}" class="block p-3 hover:bg-white/10 transition-colors {% if not notification.is_read %}bg-white/5{% endif %}">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        {% if notification.notification_type == 'success' %}
                                        <i class="fas fa-check-circle text-green-400"></i>
                                        {% elif notification.notification_type == 'warning' %}
                                        <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                                        {% elif notification.notification_type == 'error' %}
                                        <i class="fas fa-times-circle text-red-400"></i>
                                        {% else %}
                                        <i class="fas fa-info-circle text-blue-400"></i>
                                        {% endif %}
                                    </div>
                                    <div class="ml-3 flex-1">
                                        <p class="text-sm font-medium text-white">{{ notification.title }}</p>
                                        <p class="text-xs text-white/60">{{ notification.created_at|timesince }} ago</p>
                                    </div>
                                </div>
                            </a>
                            {% empty %}
                            <div class="p-4 text-center text-white/60">
                                <p>No notifications</p>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="p-2 border-t border-white/20">
                            <a href="{% url 'accounts:notifications' %}" class="block text-center text-sm text-white/80 hover:text-white">
                                View all notifications
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Messages -->
                <a href="{% url 'messaging:inbox' %}" class="relative text-white/80 hover:text-white">
                    <i class="fas fa-envelope text-xl"></i>
                </a>
                
                <!-- Quick Actions Menu -->
                <div class="relative" x-data="{ open: false }" x-ref="quickActions">
                    <button @click="open = !open; if(open) { $dispatch('close-other-dropdowns', { source: 'quickActions' }); }" 
                            class="text-white/80 hover:text-white">
                        <i class="fas fa-plus-circle text-xl"></i>
                    </button>
                    
                    <div x-show="open" 
                         @click.away="open = false" 
                         @close-other-dropdowns.window="if($event.detail.source !== 'quickActions') open = false"
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="transform opacity-0 scale-95"
                         x-transition:enter-end="transform opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="transform opacity-100 scale-100"
                         x-transition:leave-end="transform opacity-0 scale-95"
                         class="absolute right-0 mt-2 w-56 glass-dropdown rounded-lg shadow-lg overflow-hidden z-50">
                        <div class="py-1">
                            {% if user.role == 'teacher' %}
                            <a href="{% url 'attendance:mark_attendance' %}" class="block px-4 py-2 text-sm text-white/80 hover:text-white hover:bg-white/10">
                                <i class="fas fa-calendar-check w-5"></i> Mark Attendance
                            </a>
                            <a href="{% url 'academics:exam_list' %}" class="block px-4 py-2 text-sm text-white/80 hover:text-white hover:bg-white/10">
                                <i class="fas fa-pen w-5"></i> Enter Marks
                            </a>
                            {% endif %}
                            
                            {% if user.role == 'admin' %}
                            <a href="{% url 'accounts:user_create' %}" class="block px-4 py-2 text-sm text-white/80 hover:text-white hover:bg-white/10">
                                <i class="fas fa-user-plus w-5"></i> Add User
                            </a>
                            <a href="{% url 'students:create' %}" class="block px-4 py-2 text-sm text-white/80 hover:text-white hover:bg-white/10">
                                <i class="fas fa-user-graduate w-5"></i> Add Student
                            </a>
                            <a href="{% url 'teachers:create' %}" class="block px-4 py-2 text-sm text-white/80 hover:text-white hover:bg-white/10">
                                <i class="fas fa-chalkboard-teacher w-5"></i> Add Teacher
                            </a>
                            {% endif %}
                            
                            <a href="{% url 'messaging:compose' %}" class="block px-4 py-2 text-sm text-white/80 hover:text-white hover:bg-white/10">
                                <i class="fas fa-paper-plane w-5"></i> Send Message
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Profile dropdown -->
                <div class="relative" x-data="{ open: false }" x-ref="profileDropdown">
                    <button @click="open = !open; if(open) { $dispatch('close-other-dropdowns', { source: 'profileDropdown' }); }" 
                            class="flex items-center space-x-2 text-white/80 hover:text-white">
                        <img src="{{ user.get_profile_picture }}" alt="{{ user.get_full_name }}" class="h-8 w-8 rounded-full object-cover border-2 border-white">
                        <span class="hidden md:inline">{{ user.get_full_name|default:user.username }}</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    
                    <div x-show="open" 
                         @click.away="open = false" 
                         @close-other-dropdowns.window="if($event.detail.source !== 'profileDropdown') open = false"
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="transform opacity-0 scale-95"
                         x-transition:enter-end="transform opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="transform opacity-100 scale-100"
                         x-transition:leave-end="transform opacity-0 scale-95"
                         class="absolute right-0 mt-2 w-48 glass-dropdown rounded-lg shadow-lg overflow-hidden z-50">
                        <div class="py-1">
                            <a href="{% url 'accounts:profile' %}" class="block px-4 py-2 text-sm text-white/80 hover:text-white hover:bg-white/10">
                                <i class="fas fa-user w-4 mr-2"></i> Profile
                            </a>
                            <a href="{% url 'accounts:profile_edit' %}" class="block px-4 py-2 text-sm text-white/80 hover:text-white hover:bg-white/10">
                                <i class="fas fa-cog w-4 mr-2"></i> Settings
                            </a>
                            <a href="{% url 'accounts:change_password' %}" class="block px-4 py-2 text-sm text-white/80 hover:text-white hover:bg-white/10">
                                <i class="fas fa-key w-4 mr-2"></i> Change Password
                            </a>
                            <div class="border-t border-white/20 my-1"></div>
                            <a href="{% url 'accounts:logout' %}" class="block px-4 py-2 text-sm text-white/80 hover:text-white hover:bg-white/10">
                                <i class="fas fa-sign-out-alt w-4 mr-2"></i> Logout
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- Alpine.js for dropdown functionality -->
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

<style>
.glass-navbar {
    background: rgba(15, 23, 42, 0.95);
    backdrop-filter: blur(15px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
}

.glass-dropdown {
    background: rgba(15, 23, 42, 0.98);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
}

/* Ensure dropdowns are above everything */
.z-50 {
    z-index: 9999;
}

/* Smooth transitions */
.transition-all {
    transition-property: all;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 150ms;
}

/* Mobile menu toggle */
.-translate-x-full {
    transform: translateX(-100%);
}

/* Hover effects */
.glass-dropdown a:hover {
    background: rgba(51, 65, 85, 0.7);
}
</style>

<script>
function toggleMobileMenu() {
    const sidebar = document.querySelector('aside');
    sidebar.classList.toggle('-translate-x-full');
}

// Close all dropdowns when clicking outside
document.addEventListener('click', function(event) {
    const dropdowns = document.querySelectorAll('[x-data]');
    dropdowns.forEach(dropdown => {
        if (!dropdown.contains(event.target)) {
            // This is handled by Alpine's @click.away
        }
    });
});

// Prevent dropdowns from staying open after navigation
window.addEventListener('beforeunload', function() {
    const dropdowns = document.querySelectorAll('[x-data]');
    dropdowns.forEach(dropdown => {
        if (dropdown.__x) {
            dropdown.__x.$data.open = false;
        }
    });
});
</script>