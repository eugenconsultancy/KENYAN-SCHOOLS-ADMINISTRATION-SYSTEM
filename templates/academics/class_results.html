{% extends 'base.html' %}
{% load static %}

{% block title %}Class Results - {{ class_obj }}{% endblock %}

{% block page_title %}Class Results: {{ class_obj }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header with Term Selection -->
    <div class="glass-card p-6 mb-6">
        <div class="flex flex-wrap items-center justify-between">
            <div>
                <h2 class="text-2xl font-bold text-white">{{ class_obj }}</h2>
                <p class="text-white/60">{{ term }}</p>
            </div>
            
            <div class="flex space-x-2">
                <select onchange="window.location.href=this.value" class="glass-input w-auto">
                    {% for t in terms %}
                    <option value="{% url 'academics:class_results_term' class_obj.id t.id %}" 
                            {% if t.id == term.id %}selected{% endif %}>
                        {{ t }}
                    </option>
                    {% endfor %}
                </select>
                
                <a href="{% url 'reports:class_result_slip' class_obj.id exam.id %}" class="glass-button">
                    <i class="fas fa-file-pdf mr-2"></i>Download Result Slips
                </a>
            </div>
        </div>
    </div>

    <!-- Results Summary -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="glass-card p-4 text-center">
            <div class="text-2xl font-bold text-white">{{ results_data|length }}</div>
            <div class="text-sm text-white/60">Total Students</div>
        </div>
        <div class="glass-card p-4 text-center">
            <div class="text-2xl font-bold text-green-400">
                {% with present=results_data.values|dictsortreversed:"summary.average"|first %}
                    {{ present.student.get_full_name|truncatechars:15 }}
                {% endwith %}
            </div>
            <div class="text-sm text-white/60">Top Student</div>
        </div>
        <div class="glass-card p-4 text-center">
            <div class="text-2xl font-bold text-white">
                {% with avg=results_data.values|dictsortreversed:"summary.average"|first %}
                    {{ avg.summary.average|floatformat:1 }}
                {% endwith %}
            </div>
            <div class="text-sm text-white/60">Highest Average</div>
        </div>
        <div class="glass-card p-4 text-center">
            <div class="text-2xl font-bold text-white">
                {% with total=results_data.values|dictsort:"summary.average"|first %}
                    {{ total.summary.average|floatformat:1 }}
                {% endwith %}
            </div>
            <div class="text-sm text-white/60">Lowest Average</div>
        </div>
    </div>

    <!-- Results Table -->
    <div class="glass-card overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead>
                    <tr class="bg-white/10">
                        <th class="px-4 py-3 text-left text-white font-semibold">#</th>
                        <th class="px-4 py-3 text-left text-white font-semibold">Admission No.</th>
                        <th class="px-4 py-3 text-left text-white font-semibold">Student Name</th>
                        {% for subject in exam.subjects.all %}
                        <th class="px-4 py-3 text-center text-white font-semibold">{{ subject.code }}</th>
                        {% endfor %}
                        <th class="px-4 py-3 text-center text-white font-semibold">Total</th>
                        <th class="px-4 py-3 text-center text-white font-semibold">Average</th>
                        <th class="px-4 py-3 text-center text-white font-semibold">Grade</th>
                        <th class="px-4 py-3 text-center text-white font-semibold">Position</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student_id, data in results_data.items|dictsortreversed:"summary.average" %}
                    <tr class="border-t border-white/10 hover:bg-white/5">
                        <td class="px-4 py-3 text-white">{{ forloop.counter }}</td>
                        <td class="px-4 py-3 text-white">{{ data.student.admission_number }}</td>
                        <td class="px-4 py-3 text-white">{{ data.student.get_full_name }}</td>
                        {% for subject in exam.subjects.all %}
                        <td class="px-4 py-3 text-center">
                            {% with result=data.results|get_item:subject.id %}
                                {% if result %}
                                <span class="font-medium 
                                    {% if result.marks >= 80 %}text-green-400
                                    {% elif result.marks >= 60 %}text-blue-400
                                    {% elif result.marks >= 50 %}text-yellow-400
                                    {% else %}text-red-400{% endif %}">
                                    {{ result.marks }}
                                </span>
                                {% else %}
                                <span class="text-white/30">-</span>
                                {% endif %}
                            {% endwith %}
                        </td>
                        {% endfor %}
                        {% if data.summary %}
                        <td class="px-4 py-3 text-center text-white font-medium">{{ data.summary.total_marks }}</td>
                        <td class="px-4 py-3 text-center text-white font-medium">{{ data.summary.average|floatformat:1 }}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="badge 
                                {% if data.summary.mean_grade == 'A' or data.summary.mean_grade == 'A-' %}badge-success
                                {% elif data.summary.mean_grade == 'B+' or data.summary.mean_grade == 'B' or data.summary.mean_grade == 'B-' %}badge-info
                                {% elif data.summary.mean_grade == 'C+' or data.summary.mean_grade == 'C' or data.summary.mean_grade == 'C-' %}badge-warning
                                {% else %}badge-error{% endif %}">
                                {{ data.summary.mean_grade }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center text-white">{{ data.summary.position_in_class|default:"-" }}</td>
                        {% else %}
                        <td colspan="4" class="px-4 py-3 text-center text-white/60">No results</td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Performance Distribution -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
        <!-- Grade Distribution -->
        <div class="glass-card">
            <div class="border-b border-white/20 px-6 py-4">
                <h3 class="text-lg font-semibold text-white">Grade Distribution</h3>
            </div>
            <div class="p-6">
                <canvas id="gradeChart" height="200"></canvas>
            </div>
        </div>

        <!-- Subject Performance -->
        <div class="glass-card">
            <div class="border-b border-white/20 px-6 py-4">
                <h3 class="text-lg font-semibold text-white">Subject Performance</h3>
            </div>
            <div class="p-6">
                <canvas id="subjectChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Grade Distribution Chart
    const gradeCtx = document.getElementById('gradeChart').getContext('2d');
    const gradeCounts = {};
    {% for student_id, data in results_data.items %}
        {% if data.summary %}
            gradeCounts['{{ data.summary.mean_grade }}'] = (gradeCounts['{{ data.summary.mean_grade }}'] || 0) + 1;
        {% endif %}
    {% endfor %}
    
    new Chart(gradeCtx, {
        type: 'bar',
        data: {
            labels: Object.keys(gradeCounts).sort(),
            datasets: [{
                label: 'Number of Students',
                data: Object.values(gradeCounts),
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: 'white'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });

    // Subject Performance Chart
    const subjectCtx = document.getElementById('subjectChart').getContext('2d');
    const subjects = [];
    const averages = [];
    
    {% for subject in exam.subjects.all %}
        subjects.push('{{ subject.code }}');
        let total = 0;
        let count = 0;
        {% for student_id, data in results_data.items %}
            {% with result=data.results|get_item:subject.id %}
                {% if result %}
                    total += {{ result.marks }};
                    count++;
                {% endif %}
            {% endwith %}
        {% endfor %}
        averages.push(count > 0 ? (total / count).toFixed(1) : 0);
    {% endfor %}
    
    new Chart(subjectCtx, {
        type: 'line',
        data: {
            labels: subjects,
            datasets: [{
                label: 'Average Score',
                data: averages,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: 'white'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });
</script>
{% endblock %}