{% extends 'base.html' %}
{% load static %}

{% block title %}Results - Kenyan Schools System{% endblock %}

{% block page_title %}Examination Results{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Filters -->
    <div class="glass-card p-4 mb-6">
        <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="form-label">Exam</label>
                <select name="exam" class="glass-input" onchange="this.form.submit()">
                    <option value="">All Exams</option>
                    {% for exam in exams %}
                    <option value="{{ exam.id }}" {% if request.GET.exam == exam.id|stringformat:"i" %}selected{% endif %}>
                        {{ exam.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label class="form-label">Class</label>
                <select name="class" class="glass-input" onchange="this.form.submit()">
                    <option value="">All Classes</option>
                    {% for class_level in class_levels %}
                    <option value="{{ class_level.0 }}" {% if request.GET.class == class_level.0|stringformat:"i" %}selected{% endif %}>
                        {{ class_level.1 }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label class="form-label">Subject</label>
                <select name="subject" class="glass-input" onchange="this.form.submit()">
                    <option value="">All Subjects</option>
                    {% for subject in subjects %}
                    <option value="{{ subject.id }}" {% if request.GET.subject == subject.id|stringformat:"i" %}selected{% endif %}>
                        {{ subject.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="flex items-end">
                <a href="{% url 'academics:result_list' %}" class="glass-button w-full">
                    <i class="fas fa-times mr-2"></i>Clear Filters
                </a>
            </div>
        </form>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="glass-card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-white/60">Total Results</p>
                    <p class="text-2xl font-bold text-white">{{ total_results }}</p>
                </div>
                <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-chart-line text-blue-400 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="glass-card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-white/60">Overall Average</p>
                    <p class="text-2xl font-bold text-green-400">{{ overall_average|floatformat:1 }}%</p>
                </div>
                <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-chart-bar text-green-400 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="glass-card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-white/60">Pass Rate</p>
                    <p class="text-2xl font-bold text-yellow-400">{{ pass_rate|floatformat:1 }}%</p>
                </div>
                <div class="w-12 h-12 bg-yellow-500/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-check-circle text-yellow-400 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="glass-card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-white/60">Distinctions</p>
                    <p class="text-2xl font-bold text-purple-400">{{ distinction_count }}</p>
                </div>
                <div class="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-star text-purple-400 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Table -->
    <div class="glass-table overflow-hidden">
        <table class="min-w-full">
            <thead>
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-white/80 uppercase">Student</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-white/80 uppercase">Admission No.</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-white/80 uppercase">Class</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-white/80 uppercase">Exam</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-white/80 uppercase">Subject</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-white/80 uppercase">Marks</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-white/80 uppercase">Grade</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-white/80 uppercase">Points</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-white/80 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-white/10">
                {% for result in page_obj %}
                <tr class="hover:bg-white/5 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <img src="{{ result.student.user.get_profile_picture }}" 
                                 alt="{{ result.student.get_full_name }}" 
                                 class="h-8 w-8 rounded-full object-cover mr-2">
                            <span class="text-white">{{ result.student.get_full_name }}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-white">{{ result.student.admission_number }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-white">
                        Form {{ result.student.current_class }} {{ result.student.stream }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-white">{{ result.exam.name|truncatechars:20 }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-white">{{ result.subject.code }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <span class="font-bold {% if result.marks >= 80 %}text-green-400{% elif result.marks >= 60 %}text-blue-400{% elif result.marks >= 50 %}text-yellow-400{% else %}text-red-400{% endif %}">
                            {{ result.marks }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <span class="badge 
                            {% if result.grade == 'A' or result.grade == 'A-' %}badge-success
                            {% elif result.grade == 'B+' or result.grade == 'B' or result.grade == 'B-' %}badge-info
                            {% elif result.grade == 'C+' or result.grade == 'C' or result.grade == 'C-' %}badge-warning
                            {% else %}badge-error{% endif %}">
                            {{ result.grade }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-white">{{ result.points }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <div class="flex justify-end space-x-2">
                            <a href="{% url 'academics:student_results' result.student.id %}" 
                               class="text-white/60 hover:text-white" title="View Student Results">
                                <i class="fas fa-eye"></i>
                            </a>
                            {% if user.is_admin or user.is_teacher %}
                            <a href="{% url 'academics:result_edit' result.id %}" 
                               class="text-white/60 hover:text-white" title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="px-6 py-12 text-center">
                        <div class="flex flex-col items-center">
                            <div class="w-20 h-20 bg-white/5 rounded-full flex items-center justify-center mb-4">
                                <i class="fas fa-chart-line text-3xl text-white/40"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-white mb-2">No Results Found</h3>
                            <p class="text-white/60">No examination results match your filters.</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="mt-6 flex justify-center">
        <nav class="flex space-x-2">
            {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.exam %}&exam={{ request.GET.exam }}{% endif %}{% if request.GET.class %}&class={{ request.GET.class }}{% endif %}{% if request.GET.subject %}&subject={{ request.GET.subject }}{% endif %}" 
               class="glass-button">
                <i class="fas fa-chevron-left"></i>
            </a>
            {% endif %}
            
            <span class="glass-button bg-white/20">
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
            </span>
            
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if request.GET.exam %}&exam={{ request.GET.exam }}{% endif %}{% if request.GET.class %}&class={{ request.GET.class }}{% endif %}{% if request.GET.subject %}&subject={{ request.GET.subject }}{% endif %}" 
               class="glass-button">
                <i class="fas fa-chevron-right"></i>
            </a>
            {% endif %}
        </nav>
    </div>
    {% endif %}

    <!-- Export Options -->
    <div class="flex justify-end space-x-3 mt-6">
        {% if user.is_admin or user.is_teacher %}
        <a href="{% url 'academics:export_results' %}?{{ request.GET.urlencode }}" class="glass-button">
            <i class="fas fa-file-csv mr-2"></i>Export CSV
        </a>
        {% endif %}
        
        {% if request.GET.exam %}
        <a href="{% url 'reports:exam_performance_report' request.GET.exam %}" class="glass-button">
            <i class="fas fa-file-pdf mr-2"></i>Export PDF
        </a>
        {% else %}
        <button class="glass-button opacity-50 cursor-not-allowed" disabled title="Please select an exam first">
            <i class="fas fa-file-pdf mr-2"></i>Export PDF
        </button>
        {% endif %}
    </div>
</div>

<script>
    // Auto-submit filters when changed
    document.querySelectorAll('select').forEach(select => {
        select.addEventListener('change', function() {
            this.form.submit();
        });
    });
</script>
{% endblock %}