{% extends 'base.html' %}
{% load static %}

{% block title %}Generate Attendance Report - Kenyan Schools System{% endblock %}

{% block page_title %}Generate Attendance Report{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="glass-card p-6 mb-6">
        <h3 class="text-lg font-semibold text-white mb-4">Report Configuration</h3>
        
        <form method="post" enctype="multipart/form-data" id="reportForm">
            {% csrf_token %}
            
            {% if form.non_field_errors %}
            <div class="alert-error p-4 rounded-lg mb-6">
                {% for error in form.non_field_errors %}
                <p class="text-sm">{{ error }}</p>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Basic Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="md:col-span-2">
                    <label for="{{ form.title.id_for_label }}" class="form-label">
                        Report Title <span class="text-red-400">*</span>
                    </label>
                    <input type="text" name="{{ form.title.name }}" id="titleField" 
                           value="{{ form.title.value|default:'' }}" 
                           class="glass-input" 
                           placeholder="e.g., Form 1 Attendance Report - Term 1 2024"
                           required>
                    {% if form.title.errors %}
                    <p class="text-sm text-red-400 mt-1">{{ form.title.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <div>
                    <label for="{{ form.report_type.id_for_label }}" class="form-label">
                        Report Type <span class="text-red-400">*</span>
                    </label>
                    <select name="{{ form.report_type.name }}" id="reportType" class="glass-input" required>
                        <option value="">Select Report Type</option>
                        {% for value, label in form.report_type.field.choices %}
                            {% if value %}
                            <option value="{{ value }}" {% if form.report_type.value == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    {% if form.report_type.errors %}
                    <p class="text-sm text-red-400 mt-1">{{ form.report_type.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Date Range Selection -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6" id="dateRangeFields">
                <div>
                    <label for="{{ form.start_date.id_for_label }}" class="form-label">
                        Start Date <span class="text-red-400">*</span>
                    </label>
                    <input type="date" name="{{ form.start_date.name }}" id="startDate" 
                           value="{{ form.start_date.value|default:'' }}" 
                           class="glass-input" required>
                    {% if form.start_date.errors %}
                    <p class="text-sm text-red-400 mt-1">{{ form.start_date.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <div>
                    <label for="{{ form.end_date.id_for_label }}" class="form-label">
                        End Date <span class="text-red-400">*</span>
                    </label>
                    <input type="date" name="{{ form.end_date.name }}" id="endDate" 
                           value="{{ form.end_date.value|default:'' }}" 
                           class="glass-input" required>
                    {% if form.end_date.errors %}
                    <p class="text-sm text-red-400 mt-1">{{ form.end_date.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Filters -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="{{ form.class_level.id_for_label }}" class="form-label">
                        Class Level (Optional)
                    </label>
                    <select name="{{ form.class_level.name }}" id="classLevel" class="glass-input">
                        <option value="">All Classes</option>
                        {% for value, label in form.class_level.field.choices %}
                            {% if value %}
                            <option value="{{ value }}" {% if form.class_level.value == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    {% if form.class_level.errors %}
                    <p class="text-sm text-red-400 mt-1">{{ form.class_level.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <div>
                    <label for="{{ form.stream.id_for_label }}" class="form-label">
                        Stream (Optional)
                    </label>
                    <select name="{{ form.stream.name }}" id="stream" class="glass-input">
                        <option value="">All Streams</option>
                        {% for value, label in form.stream.field.choices %}
                            {% if value %}
                            <option value="{{ value }}" {% if form.stream.value == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    {% if form.stream.errors %}
                    <p class="text-sm text-red-400 mt-1">{{ form.stream.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Report Options -->
            <div class="bg-white/5 rounded-lg p-4 mb-6">
                <h4 class="text-white font-medium mb-3">Report Options</h4>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="include_charts" class="form-checkbox h-4 w-4 text-blue-600" checked>
                        <span class="text-white/80">Include Charts</span>
                    </label>
                    
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="include_summary" class="form-checkbox h-4 w-4 text-blue-600" checked>
                        <span class="text-white/80">Include Summary</span>
                    </label>
                    
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="include_details" class="form-checkbox h-4 w-4 text-blue-600" checked>
                        <span class="text-white/80">Include Details</span>
                    </label>
                    
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="group_by_class" class="form-checkbox h-4 w-4 text-blue-600">
                        <span class="text-white/80">Group by Class</span>
                    </label>
                    
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="show_percentages" class="form-checkbox h-4 w-4 text-blue-600" checked>
                        <span class="text-white/80">Show Percentages</span>
                    </label>
                    
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="show_totals" class="form-checkbox h-4 w-4 text-blue-600" checked>
                        <span class="text-white/80">Show Totals</span>
                    </label>
                </div>
            </div>
            
            <!-- Format Selection -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label class="form-label">Output Format</label>
                    <div class="flex space-x-4 mt-2">
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="format" value="pdf" class="form-radio h-4 w-4 text-blue-600" checked>
                            <span class="text-white/80">PDF</span>
                        </label>
                        
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="format" value="excel" class="form-radio h-4 w-4 text-blue-600">
                            <span class="text-white/80">Excel</span>
                        </label>
                        
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="format" value="csv" class="form-radio h-4 w-4 text-blue-600">
                            <span class="text-white/80">CSV</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Preview Section -->
            <div class="bg-blue-500/10 rounded-lg p-4 mb-6">
                <div class="flex items-start">
                    <i class="fas fa-info-circle text-blue-400 mt-1 mr-3"></i>
                    <div>
                        <h4 class="text-white font-medium mb-2">Report Preview</h4>
                        <p id="previewText" class="text-sm text-white/80">
                            {% if form.title.value %}
                                {{ form.title.value }} - 
                            {% endif %}
                            {% if form.start_date.value and form.end_date.value %}
                                {{ form.start_date.value|date:"d M Y" }} to {{ form.end_date.value|date:"d M Y" }}
                            {% else %}
                                Select dates to see preview
                            {% endif %}
                        </p>
                        <p id="filterPreview" class="text-xs text-white/60 mt-1">
                            {% if form.class_level.value %}Form {{ form.class_level.value }}{% endif %}
                            {% if form.stream.value %} {{ form.stream.value }}{% endif %}
                            {% if not form.class_level.value and not form.stream.value %}All Classes & Streams{% endif %}
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Generation Progress (hidden by default) -->
            <div id="progressSection" class="hidden mb-6">
                <div class="flex justify-between text-sm text-white/80 mb-2">
                    <span>Generating Report...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="progress h-2">
                    <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                </div>
                <p id="progressMessage" class="text-xs text-white/40 mt-2">Preparing data...</p>
            </div>
            
            <!-- Form Actions -->
            <div class="flex justify-end space-x-3 pt-6 border-t border-white/20">
                <a href="{% url 'attendance:attendance_reports' %}" class="glass-button">
                    Cancel
                </a>
                <button type="submit" class="glass-button bg-green-600/50" id="generateBtn">
                    <i class="fas fa-file-export mr-2"></i>Generate Report
                </button>
            </div>
        </form>
    </div>
    
    <!-- Report Templates -->
    <div class="glass-card p-6">
        <h3 class="text-lg font-semibold text-white mb-4">Quick Report Templates</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button type="button" onclick="loadTemplate('daily')" class="glass-button text-left py-3">
                <i class="fas fa-calendar-day mr-2"></i>
                <div>
                    <div class="font-medium">Daily Summary</div>
                    <div class="text-xs text-white/60">Today's attendance by class</div>
                </div>
            </button>
            
            <button type="button" onclick="loadTemplate('weekly')" class="glass-button text-left py-3">
                <i class="fas fa-calendar-week mr-2"></i>
                <div>
                    <div class="font-medium">Weekly Report</div>
                    <div class="text-xs text-white/60">Last 7 days trends</div>
                </div>
            </button>
            
            <button type="button" onclick="loadTemplate('monthly')" class="glass-button text-left py-3">
                <i class="fas fa-calendar-alt mr-2"></i>
                <div>
                    <div class="font-medium">Monthly Report</div>
                    <div class="text-xs text-white/60">Current month summary</div>
                </div>
            </button>
            
            <button type="button" onclick="loadTemplate('term')" class="glass-button text-left py-3">
                <i class="fas fa-layer-group mr-2"></i>
                <div>
                    <div class="font-medium">Term Report</div>
                    <div class="text-xs text-white/60">Current term overview</div>
                </div>
            </button>
            
            <button type="button" onclick="loadTemplate('class')" class="glass-button text-left py-3">
                <i class="fas fa-users mr-2"></i>
                <div>
                    <div class="font-medium">Class Report</div>
                    <div class="text-xs text-white/60">Specific class analysis</div>
                </div>
            </button>
            
            <button type="button" onclick="loadTemplate('late')" class="glass-button text-left py-3">
                <i class="fas fa-clock mr-2"></i>
                <div>
                    <div class="font-medium">Late Comers</div>
                    <div class="text-xs text-white/60">Frequent late students</div>
                </div>
            </button>
        </div>
    </div>
</div>

<script>
    // Update preview based on form inputs
    const titleField = document.getElementById('titleField');
    const startDate = document.getElementById('startDate');
    const endDate = document.getElementById('endDate');
    const classLevel = document.getElementById('classLevel');
    const stream = document.getElementById('stream');
    const previewText = document.getElementById('previewText');
    const filterPreview = document.getElementById('filterPreview');
    
    function updatePreview() {
        let text = '';
        if (titleField.value) {
            text = titleField.value + ' - ';
        }
        
        if (startDate.value && endDate.value) {
            const start = new Date(startDate.value).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
            const end = new Date(endDate.value).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
            text += start + ' to ' + end;
        } else {
            text += 'Select dates';
        }
        previewText.textContent = text;
        
        let filter = '';
        if (classLevel.value) {
            filter += 'Form ' + classLevel.options[classLevel.selectedIndex].text;
        }
        if (stream.value) {
            filter += filter ? ' ' + stream.value : stream.options[stream.selectedIndex].text;
        }
        if (!filter) {
            filter = 'All Classes & Streams';
        }
        filterPreview.textContent = filter;
    }
    
    titleField.addEventListener('input', updatePreview);
    startDate.addEventListener('change', updatePreview);
    endDate.addEventListener('change', updatePreview);
    classLevel.addEventListener('change', updatePreview);
    stream.addEventListener('change', updatePreview);
    
    // Template loader
    function loadTemplate(template) {
        const today = new Date();
        const endDateStr = today.toISOString().split('T')[0];
        
        switch(template) {
            case 'daily':
                startDate.value = endDateStr;
                endDate.value = endDateStr;
                titleField.value = 'Daily Attendance Report - ' + today.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                document.getElementById('reportType').value = 'daily';
                break;
                
            case 'weekly':
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - 7);
                startDate.value = weekStart.toISOString().split('T')[0];
                endDate.value = endDateStr;
                titleField.value = 'Weekly Attendance Report - Week ' + getWeekNumber(today);
                document.getElementById('reportType').value = 'weekly';
                break;
                
            case 'monthly':
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                startDate.value = monthStart.toISOString().split('T')[0];
                endDate.value = endDateStr;
                titleField.value = 'Monthly Attendance Report - ' + today.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
                document.getElementById('reportType').value = 'monthly';
                break;
                
            case 'term':
                // This would need current term dates from backend
                document.getElementById('reportType').value = 'term';
                titleField.value = 'Term Attendance Report';
                break;
                
            case 'class':
                document.getElementById('reportType').value = 'custom';
                titleField.value = 'Class Attendance Analysis';
                break;
                
            case 'late':
                document.getElementById('reportType').value = 'custom';
                titleField.value = 'Late Comers Report';
                break;
        }
        
        updatePreview();
    }
    
    function getWeekNumber(date) {
        const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
        const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
        return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
    }
    
    // Form submission with progress
    document.getElementById('reportForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate dates
        if (new Date(startDate.value) > new Date(endDate.value)) {
            alert('End date must be after start date');
            return;
        }
        
        // Show progress
        document.getElementById('progressSection').classList.remove('hidden');
        document.getElementById('generateBtn').disabled = true;
        
        // Simulate progress (in real app, this would be handled by server-sent events)
        let progress = 0;
        const messages = [
            'Collecting attendance data...',
            'Processing statistics...',
            'Generating charts...',
            'Formatting report...',
            'Finalizing...'
        ];
        
        const interval = setInterval(function() {
            progress += 2;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressPercent').textContent = progress + '%';
            
            const messageIndex = Math.floor(progress / 20);
            if (messageIndex < messages.length) {
                document.getElementById('progressMessage').textContent = messages[messageIndex];
            }
            
            if (progress >= 100) {
                clearInterval(interval);
                document.getElementById('progressMessage').textContent = 'Report ready! Redirecting...';
                
                // Submit the form
                setTimeout(function() {
                    document.getElementById('reportForm').submit();
                }, 500);
            }
        }, 100);
    });
    
    // Initialize preview
    updatePreview();
</script>
{% endblock %}